<script>
const PASSWORD = "1234";
const MERMA = 50;
const SYSTEMS = {
  "Corrediza Europea": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 2, dividirAncho: true }, // solo este divide el ancho
    "MTG2176": { altos: 2, anchos: 0 },
    "EUAA01": { cantidad: 1, tipo: "herraje" },
  },
  "Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 4, tipo: "herraje" },
  },
  "Batiente": {},
  "ProyecciÃ³n": {},
  "Otro": {}
};

let lastResults = null;
let currentUser = null;

// --- UTILIDADES DE COLOR ---
function colorForId(id){
  const hash = [...id].reduce((a,c)=>a+c.charCodeAt(0),0);
  const hue = hash % 360;
  const rgb = hslToRgb(hue/360,0.6,0.5);
  return rgb;
}
function hslToRgb(h, s, l){
  let r, g, b;
  if(s == 0){ r = g = b = l; }
  else{
    const hue2rgb = (p,q,t)=>{
      if(t<0)t+=1;if(t>1)t-=1;
      if(t<1/6)return p+(q-p)*6*t;
      if(t<1/2)return q;
      if(t<2/3)return p+(q-p)*(2/3-t)*6;
      return p;
    }
    const q = l < 0.5 ? l*(1+s) : l+s-l*s;
    const p = 2*l-q;
    r = hue2rgb(p,q,h+1/3);
    g = hue2rgb(p,q,h);
    b = hue2rgb(p,q,h-1/3);
  }
  return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];
}

// --- LOGIN ---
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u || !p){ alert('Ingrese usuario y contraseÃ±a'); return; }
  if(p !== PASSWORD){ alert('ContraseÃ±a incorrecta'); return; }
  currentUser = u;
  document.getElementById('hdrUser').innerText = `Usuario: ${u}`;
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('appSection').style.display = 'block';
  addRow();
}

// --- AGREGAR FILA ---
function addRow(){
  const tbody = document.querySelector('#tableWindows tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="V1"></td>
    <td><input type="number" placeholder="1500"></td>
    <td><input type="number" placeholder="1000"></td>
    <td><input type="number" value="1"></td>
    <td><select>${Object.keys(SYSTEMS).map(s=>`<option value="${s}">${s}</option>`).join('')}</select></td>
    <td><input type="number" value="6000"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>
  `;
  tbody.appendChild(tr);
}

// --- CALCULAR ---
function calcular(){
  const filas = [...document.querySelectorAll('#tableWindows tbody tr')];
  if(filas.length === 0){ alert('Agrega al menos una ventana'); return; }

  const data = [];
  filas.forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    data.push({
      winId: tds[0].querySelector('input').value.trim() || '-',
      alto: parseFloat(tds[1].querySelector('input').value)||0,
      ancho: parseFloat(tds[2].querySelector('input').value)||0,
      qty: parseInt(tds[3].querySelector('input').value)||1,
      sistema: tds[4].querySelector('select').value,
      largo: parseFloat(tds[5].querySelector('input').value)||6000
    });
  });

  const resumenPorPerfil = {};
  const tirasPorPerfil = {};

  data.forEach(item=>{
    const sys = SYSTEMS[item.sistema];
    if(!sys) return;

    Object.entries(sys).forEach(([perfil, def])=>{
      // ðŸ”¹ Si es herraje, sumar unidades sin cortes
      if (def.tipo === "herraje") {
        const cantidadVentanas = item.qty || 1;
        const cantidadTotal = (def.cantidad || 1) * cantidadVentanas;
        resumenPorPerfil[perfil] = (resumenPorPerfil[perfil] || 0) + cantidadTotal;
        return;
      }

      const cortes = [];
      for(let i=0;i<def.altos;i++) cortes.push(item.alto);
      const anchoCorte = def.dividirAncho ? item.ancho / 2 : item.ancho;
      for(let j=0;j<def.anchos;j++) cortes.push(anchoCorte);

      const totalCortes = cortes.length * item.qty;
      const largoTira = item.largo - MERMA;
      const cortesPorTira = [];
      let actual = 0, suma = 0;

      for(let i=0;i<totalCortes;i++){
        const valor = cortes[i % cortes.length];
        if(suma + valor <= largoTira){
          cortesPorTira[actual] = cortesPorTira[actual] || [];
          cortesPorTira[actual].push(valor);
          suma += valor;
        }else{
          actual++;
          suma = valor;
          cortesPorTira[actual] = [valor];
        }
      }

      resumenPorPerfil[perfil] = (resumenPorPerfil[perfil]||0)+cortesPorTira.length;
      tirasPorPerfil[perfil] = tirasPorPerfil[perfil]||[];
      cortesPorTira.forEach((arr)=>{
        const usado = arr.reduce((a,b)=>a+b,0);
        const sobrante = largoTira - usado;
        tirasPorPerfil[perfil].push({
          largo:item.largo,
          cortes:arr,
          winRefs:arr.map(()=>item.winId),
          sobrante
        });
      });
    });
  });

  // --- Calcular aprovechamiento ---
  let totalUsado = 0;
  let totalDisponible = 0;
  Object.values(tirasPorPerfil).forEach(perfilTiras=>{
    perfilTiras.forEach(tira=>{
      const largoTira = tira.largo - MERMA;
      const usado = tira.cortes.reduce((a,b)=>a+b,0);
      totalUsado += usado;
      totalDisponible += largoTira;
    });
  });
  const aprovechamiento = totalDisponible>0?(totalUsado/totalDisponible)*100:0;

  lastResults = { 
    proyecto: document.getElementById('projectName').value, 
    usuario: currentUser, 
    filas: data, 
    resumenPorPerfil, 
    tirasPorPerfil,
    aprovechamiento
  };

  // --- Mostrar resumen ---
  let html = `<b>Resumen de Ventanas:</b><br>`;
  data.forEach(f=>{
    html += `${f.winId} = ${f.sistema} â€” Ancho: ${f.ancho} mm, Alto: ${f.alto} mm, Cant: ${f.qty}<br>`;
  });
  html += `<br><b>Tiras / Unidades por perfil:</b><br>`;
  Object.entries(resumenPorPerfil).forEach(([perfil, cant])=>{
    let esHerraje=false;
    for(const sistema in SYSTEMS){
      if(SYSTEMS[sistema][perfil]?.tipo==="herraje"){esHerraje=true;break;}
    }
    const etiqueta=esHerraje?"unidades":"tiras";
    html += `${perfil}: ${cant} ${etiqueta}<br>`;
  });
  html += `<br><b>Aprovechamiento total:</b> ${aprovechamiento.toFixed(2)}%`;
  document.getElementById('summary').innerHTML = html;
}

// --- EXPORTAR PDF ---
function exportPdf(){
  if(!lastResults){ alert('Calcule primero.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 36;
  let y = margin;

  doc.setFontSize(16);
  doc.setTextColor(20,220,180);
  doc.text('OPTIMIZADOR DE CORTES - REPORTE TÃ‰CNICO', pageW/2, y, {align:'center'});
  y += 20;

  doc.setFontSize(10);
  doc.setTextColor(0,0,0);
  doc.text(`Proyecto: ${lastResults.proyecto || '-'}`, margin, y);
  doc.text(`Usuario: ${lastResults.usuario || '-'}`, margin+300, y);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, pageW - margin - 160, y);
  y += 20;

  doc.setFontSize(11);
  doc.text('RESUMEN DE VENTANAS', margin, y);
  y += 12;
  doc.setFontSize(9);
  lastResults.filas.forEach(f=>{
    doc.text(`${f.winId} = ${f.sistema} â€” Ancho: ${f.ancho} mm, Alto: ${f.alto} mm, Cantidad: ${f.qty}`, margin, y);
    y += 10;
  });
  y += 10;

  // Aprovechamiento
  doc.setFontSize(11);
  doc.setTextColor(0,100,0);
  doc.text(`Aprovechamiento total del material: ${lastResults.aprovechamiento.toFixed(2)}%`, margin, y);
  doc.setTextColor(0,0,0);
  y += 20;

  const barMaxWidth = Math.min(pageW - margin*2 - 160, 900);
  const barH = 14;
  const gap = 36;

  const perfiles = Object.keys(lastResults.tirasPorPerfil || {});
  perfiles.forEach(perfil=>{
    let esHerraje=false;
    for(const sistema in SYSTEMS){
      if(SYSTEMS[sistema][perfil]?.tipo==="herraje"){esHerraje=true;break;}
    }
    if(esHerraje) return;

    if(y > pageH - 120){ doc.addPage(); y = margin; }
    doc.setFontSize(11);
    doc.text(`${perfil} â€” Diagramas de corte`, margin, y);
    y += 10;

    (lastResults.tirasPorPerfil[perfil]||[]).forEach((tira,ti)=>{
      if(y > pageH - 100){ doc.addPage(); y = margin; }
      const scale = barMaxWidth / tira.largo;
      let x = margin + 120;
      const baseY = y;

      doc.setFontSize(9);
      doc.text(`Tira ${ti+1}`, margin + 60, baseY + barH/2 + 3, {align:'right'});

      doc.setDrawColor(100);
      doc.rect(x, baseY, barMaxWidth, barH);

      for(let ci=0; ci<tira.cortes.length; ci++){
        const corte = tira.cortes[ci];
        const win = tira.winRefs[ci];
        const color = colorForId(win);
        const seg = corte * scale;

        doc.setFillColor(color[0],color[1],color[2]);
        doc.rect(x, baseY, seg, barH, 'F');

        const etiqueta = `${win} - ${corte} mm`;
        doc.setFontSize(8);
        doc.setTextColor(255,255,255);
        doc.text(etiqueta, x + seg/2, baseY + barH/2 + 3, {align:'center'});
        x += seg;
      }

      if(tira.sobrante > 0){
        const sobraW = tira.sobrante * scale;
        doc.setFillColor(120,120,120);
        doc.rect(x, baseY, sobraW, barH, 'F');
        doc.setFontSize(8);
        doc.setTextColor(0,0,0);
        doc.text(`Sobrante ${tira.sobrante} mm`, x + sobraW/2, baseY + barH/2 + 3, {align:'center'});
      }

      doc.setFontSize(8);
      doc.setTextColor(0,0,0);
      doc.text(`Tira utilizada: ${tira.largo} mm`, margin + barMaxWidth/2, baseY + barH + 14, {align:'center'});
      y += gap;
    });
    y += 10;
  });

  doc.save(`Cortes_${Date.now()}.pdf`);
}

// --- BORRAR TODO ---
function borrarTodo(){
  if(!confirm('Â¿Borrar todo?')) return;
  document.querySelector('#tableWindows tbody').innerHTML='';
  lastResults=null;
  document.getElementById('summary').innerText='Presiona "Calcular resumen" para ver totales por perfil.';
}
</script>
