<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Optimizador de Cortes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #f4f6f8;
      margin: 0;
      color: #222;
    }
    .login, .panel {
      background: #fff;
      padding: 20px;
      margin: 40px auto;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 1100px;
    }
    .login input {
      padding: 10px;
      font-size: 14px;
      width: 200px;
    }
    .btn {
      background: #00b894;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .btn:hover { background: #019874; }
    .btn.ghost { background: #dfe6e9; color: #333; }
    .btn.danger { background: #d63031; }
    .muted { color: #666; }
    .center { text-align: center; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #ccc;
      text-align: center;
    }
    input, select {
      width: 100%;
      padding: 6px;
      font-size: 13px;
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginSection" class="login">
  <h2>ðŸ”’ Acceso al Optimizador</h2>
  <p>Introduce la contraseÃ±a para continuar:</p>
  <input type="password" id="passwordInput" placeholder="ContraseÃ±a">
  <button class="btn" onclick="checkLogin()">Entrar</button>
  <p id="loginMsg" class="muted"></p>
</div>

<!-- APP -->
<div id="appSection" style="display:none">
  <div class="panel">
    <div class="row" style="align-items:center;gap:12px">
      <div class="col">
        <label>Proyecto / Cliente</label>
        <input id="projectName" type="text" placeholder="Ej. Proyecto Alfa - Edificio A">
      </div>

      <div style="width:300px">
        <label>&nbsp;</label>
        <div class="actions">
          <button class="btn" onclick="addRow()">âž• Agregar ventana</button>
          <button class="btn ghost" onclick="calcular()">ðŸ§® Calcular resumen</button>
          <button class="btn" onclick="exportPdf()">ðŸ“„ Exportar PDF</button>
          <button class="btn danger" onclick="borrarTodo()">ðŸ—‘ Borrar todo</button>
        </div>
      </div>
    </div>

    <h3 style="margin-top:14px;color:#00b894">Ventanas (ingreso manual)</h3>

    <table id="tableWindows">
      <thead>
        <tr>
          <th>ID Ventana</th>
          <th>Ancho (mm)</th>
          <th>Alto (mm)</th>
          <th>Cantidad</th>
          <th>Sistema</th>
          <th>Largo Tira (mm)</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="summary" class="muted center">Presiona "Calcular resumen" para ver totales por perfil.</div>
  </div>
</div>

<script>
const PASSWORD = "1234";
const MERMA = 50;
const LARGO_DEFAULT = 6000;

// --- DefiniciÃ³n de sistemas ---
const SYSTEMS = {
  "Corrediza Europea 3 Hojas": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 6, anchos: 6, dividirAncho: 3 }, // Divide ancho entre 3
    "MTG2176": { altos: 4, anchos: 0 },
    "F04": { tipo: "herraje", calcularSegun: { "MTG2177": 2, "MTG2176": 1 } },
    "EUAA05L": { cantidad: 20, tipo: "herraje" },
    "EUAP01": { cantidad: 1.5, tipo: "herraje" },
    "EUCH01": { cantidad: 2, tipo: "herraje" },
    "EUCH02": { cantidad: 2, tipo: "herraje" },
  },
  "Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 1, tipo: "herraje" },
  }
};

let lastResults = null;

// --- LOGIN ---
function checkLogin(){
  const pass = document.getElementById('passwordInput').value.trim();
  const msg = document.getElementById('loginMsg');
  if(pass === PASSWORD){
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('appSection').style.display = 'block';
  } else {
    msg.textContent = 'ContraseÃ±a incorrecta. Intenta nuevamente.';
  }
}

// --- AÃ‘ADIR FILA ---
function addRow(){
  const tbody = document.querySelector('#tableWindows tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="V1"></td>
    <td><input type="number" placeholder="1000"></td>
    <td><input type="number" placeholder="1500"></td>
    <td><input type="number" value="1" min="1"></td>
    <td><select>${Object.keys(SYSTEMS).map(s=>`<option value="${s}">${s}</option>`).join('')}</select></td>
    <td><input type="number" value="${LARGO_DEFAULT}" min="1000"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>
  `;
  tbody.appendChild(tr);
}

// --- BORRAR TODO ---
function borrarTodo(){
  if(confirm('Â¿Seguro que deseas borrar todo?')){
    document.querySelector('#tableWindows tbody').innerHTML = '';
    document.getElementById('summary').innerHTML = 'Presiona "Calcular resumen" para ver totales por perfil.';
    lastResults = null;
  }
}

// --- CALCULAR (simplificado) ---
function calcular(){
  const rows = [...document.querySelectorAll('#tableWindows tbody tr')];
  if(rows.length === 0){ alert('Agrega al menos una ventana.'); return; }

  const filas = [];
  rows.forEach(tr=>{
    const celdas = tr.querySelectorAll('input,select');
    const [id, ancho, alto, qty, sistema, largo] = [...celdas].map(c=>c.value);
    filas.push({ winId:id||'-', ancho:+ancho, alto:+alto, qty:+qty, sistema, largo:+largo });
  });

  const resumen = {};
  filas.forEach(item=>{
    const sys = SYSTEMS[item.sistema];
    if(!sys) return;

    for(const [perfil,def] of Object.entries(sys)){
      if(def.tipo === "herraje") continue;
      let cortesBase = [];

      for(let i=0;i<(def.altos||0);i++) cortesBase.push(item.alto);
      let anchoCorte = item.ancho;
      if(def.dividirAncho){
        const divisor = typeof def.dividirAncho === 'number' ? def.dividirAncho : 2;
        anchoCorte = +(item.ancho / divisor).toFixed(2);
      }
      for(let j=0;j<(def.anchos||0);j++) cortesBase.push(anchoCorte);

      if(!resumen[perfil]) resumen[perfil]=[];
      for(let k=0;k<item.qty;k++) resumen[perfil].push(...cortesBase);
    }
  });

  let html = `<h4>Resumen de perfiles</h4><ul>`;
  for(const [perfil,cortes] of Object.entries(resumen)){
    const totalML = (cortes.reduce((a,b)=>a+b,0)/1000).toFixed(2);
    html += `<li>${perfil}: ${cortes.length} cortes (${totalML} m lineales)</li>`;
  }
  html += `</ul>`;

  document.getElementById('summary').innerHTML = html;
  lastResults = { filas, resumen };
}

// --- EXPORTAR PDF ---
function exportPdf(){
  if(!lastResults){ alert('Calcule primero.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
  const margin = 36, pageW = doc.internal.pageSize.getWidth();
  let y = margin;

  doc.setFontSize(16);
  doc.setTextColor(0,184,148);
  doc.text('OPTIMIZADOR DE CORTES - REPORTE TÃ‰CNICO', pageW/2, y, {align:'center'});
  y += 24;

  doc.setFontSize(10);
  doc.setTextColor(0,0,0);
  doc.text(`Proyecto: ${document.getElementById('projectName').value || '-'}`, margin, y);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, pageW - margin - 150, y);
  y += 20;

  doc.setFontSize(11);
  doc.text('RESUMEN DE VENTANAS', margin, y); y += 12;
  lastResults.filas.forEach(f=>{
    doc.setFontSize(9);
    doc.text(`${f.winId} = ${f.sistema} â€” Ancho: ${f.ancho} mm, Alto: ${f.alto} mm, Cantidad: ${f.qty}`, margin, y);
    y += 10;
  });

  doc.save(`Cortes_${Date.now()}.pdf`);
}
</script>
</body>
</html>
