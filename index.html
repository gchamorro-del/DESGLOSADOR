<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Optimizador de Cortes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .login, .app { max-width: 500px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 10px; }
    .hidden { display: none; }
    label { display: block; margin-top: 10px; }
    input, select, button { margin-top: 5px; width: 100%; padding: 8px; }
    h2 { text-align: center; }
  </style>
</head>
<body>

<div class="login" id="login">
  <h2>Acceso</h2>
  <label>Contraseña:</label>
  <input type="password" id="password">
  <button onclick="login()">Entrar</button>
</div>

<div class="app hidden" id="app">
  <h2>Optimizador de Cortes</h2>
  <label for="sistema">Sistema:</label>
  <select id="sistema">
    <option value="corrediza">Ventana Corrediza Europea</option>
    <option value="fija">Ventana Fija</option>
  </select>

  <label>Alto (mm):</label>
  <input type="number" id="alto" placeholder="ej. 1200">
  <label>Ancho (mm):</label>
  <input type="number" id="ancho" placeholder="ej. 800">
  <label>Largo disponible de tira (mm):</label>
  <input type="number" id="largo" value="6000">

  <button onclick="calcular()">Calcular y Exportar PDF</button>
</div>

<script>
const PASSWORD = "1234"; // cámbiala si quieres
const MERMA = 150;

const sistemas = {
  "corrediza": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 2 },
    "MTG2078": { altos: 2, anchos: 1 },
    "MTG2176": { altos: 2, anchos: 0 }
  },
  "fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 }
  }
};

function login() {
  const pass = document.getElementById("password").value;
  if (pass === PASSWORD) {
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
  } else {
    alert("Contraseña incorrecta");
  }
}

function calcular() {
  const alto = parseInt(document.getElementById("alto").value);
  const ancho = parseInt(document.getElementById("ancho").value);
  const largoDisponible = parseInt(document.getElementById("largo").value);
  const sistema = document.getElementById("sistema").value;

  if (!alto || !ancho || !largoDisponible) {
    alert("Por favor ingresa alto, ancho y largo disponible.");
    return;
  }

  let piezasPorPerfil = {};
  for (let perfil in sistemas[sistema]) {
    const def = sistemas[sistema][perfil];
    let piezas = [];
    for (let i = 0; i < def.altos; i++) piezas.push(alto);
    for (let i = 0; i < def.anchos; i++) piezas.push(ancho);
    piezasPorPerfil[perfil] = piezas;
  }

  let resumen = {};
  let tirasPorPerfil = {};

  for (let perfil in piezasPorPerfil) {
    let piezas = piezasPorPerfil[perfil].slice().sort((a,b)=>b-a);
    let tiras = [];
    while (piezas.length > 0) {
      let espacio = largoDisponible;
      let cortes = [];
      for (let i = 0; i < piezas.length;) {
        let pieza = piezas[i] + MERMA;
        if (pieza <= espacio) {
          cortes.push(piezas[i]);
          espacio -= pieza;
          piezas.splice(i,1);
        } else {
          i++;
        }
      }
      tiras.push({ cortes, sobrante: espacio });
    }
    tirasPorPerfil[perfil] = tiras;
    resumen[perfil] = tiras.length;
  }

  exportarPDF(resumen, tirasPorPerfil, largoDisponible);
}

function exportarPDF(resumen, tirasPorPerfil, largoDisponible) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;

  doc.setFontSize(14);
  doc.text("Resumen Global", 10, y); y += 10;
  doc.setFontSize(12);
  for (let perfil in resumen) {
    doc.text(`Total tiras ${perfil} = ${resumen[perfil]}`, 10, y);
    y += 7;
  }

  y += 10;
  doc.setFontSize(14);
  doc.text("Detalle de Cortes", 10, y); y += 10;

  for (let perfil in tirasPorPerfil) {
    doc.setFontSize(12);
    doc.text(`Perfil ${perfil}:`, 10, y); y += 8;
    tirasPorPerfil[perfil].forEach((tira, idx) => {
      doc.text(`Tira ${idx+1}`, 10, y); y += 5;
      let x = 20;
      let escala = 170 / largoDisponible;
      tira.cortes.forEach(c => {
        let ancho = c * escala;
        doc.rect(x, y, ancho, 10);
        doc.text(`${c}mm`, x + ancho/2, y+6, { align:"center" });
        x += ancho;
      });
      if (tira.sobrante > 0) {
        let ancho = tira.sobrante * escala;
        doc.setFillColor(200,200,200);
        doc.rect(x, y, ancho, 10, "F");
        doc.text(`Sobrante ${tira.sobrante}`, x+ancho/2, y+6, { align:"center" });
      }
      y += 15;
      if (y > 270) { doc.addPage(); y = 20; }
    });
    y += 5;
  }

  doc.save("cortes.pdf");
}
</script>
</body>
</html>
