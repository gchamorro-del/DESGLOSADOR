<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Optimizador T√©cnico de Cortes ‚Äî Versi√≥n Final</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {
    font-family: "Inter", system-ui, sans-serif;
    background: #0b0f14;
    color: #e6eef6;
    margin: 0;
  }
  header {
    background: linear-gradient(90deg, #0060df, #008080);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h1 { font-size: 18px; color: white; margin: 0; }
  .wrap { max-width: 1200px; margin: 20px auto; padding: 10px; }
  .panel {
    background: #101820;
    border: 1px solid #243040;
    border-radius: 10px;
    padding: 16px;
  }
  label { font-size: 13px; color: #98a2b3; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; color: white; }
  th, td { border: 1px solid #1c2836; padding: 6px; text-align: center; font-size: 13px; }
  .btn { background: #008080; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
  .btn.ghost { background: transparent; border: 1px solid #2e3b48; }
  .btn.danger { background: #ef4444; color: #fff; }
  #summary { background: #0f1419; padding: 10px; border-radius: 8px; margin-top: 12px; border: 1px solid #1f2b36; }
</style>
</head>
<body>
<header>
  <h1>üî© Optimizador T√©cnico de Cortes ‚Äî Versi√≥n Final</h1>
  <div id="hdrUser" style="font-size:13px;">Offline</div>
</header>

<div class="wrap">
  <div class="panel">
    <div>
      <label>Proyecto / Cliente</label>
      <input id="projectName" type="text" placeholder="Ej. Proyecto Alfa" style="width:300px;">
      <label style="margin-left:10px;">Usuario</label>
      <input id="loginUser" type="text" placeholder="Ej. Gustavo" style="width:160px;">
      <label style="margin-left:10px;">Largo de tira (mm)</label>
      <input id="globalLargo" type="text" value="6000" style="width:100px;">
      <button class="btn" onclick="addRow()">‚ûï Agregar ventana</button>
      <button class="btn" onclick="calcular()">üßÆ Calcular</button>
      <button class="btn ghost" onclick="exportPdf()">üìÑ Exportar PDF</button>
      <button class="btn danger" onclick="borrarTodo()">üóë Borrar todo</button>
    </div>

    <table id="tableWindows">
      <thead>
        <tr>
          <th>ID Ventana</th>
          <th>Ancho</th>
          <th>Alto</th>
          <th>Cantidad</th>
          <th>Sistema</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="summary">Presiona ‚ÄúCalcular‚Äù para ver el resumen.</div>
  </div>
</div>

<script>
const MERMA = 50;
let lastResults = null;
let sobrantesGlobales = [];

// === SISTEMAS Y PERFILES ===
const SYSTEMS = {
  "Corrediza Europea 3 Hojas": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 4, dividirAncho: true },
    "MTG2176": { altos: 4, anchos: 0 },
    "F04": { tipo: "herraje", calcularSegun: { "MTG2177": 2, "MTG2176": 1 } },
    "EUAA05L": { cantidad: 20, tipo: "herraje" },
    "EUAP01": { cantidad: 1.5, tipo: "herraje" },
    "EUCH01": { cantidad: 2, tipo: "herraje" },
    "EUCH02": { cantidad: 2, tipo: "herraje" }
  },
  "Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 4, tipo: "herraje" }
  },
  "Batiente": {},
  "Proyecci√≥n": {},
  "Otro": {}
};

function addRow() {
  const tbody = document.querySelector("#tableWindows tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input type="text" placeholder="v1"></td>
    <td><input type="number" placeholder="1000" min="0"></td>
    <td><input type="number" placeholder="1500" min="0"></td>
    <td><input type="number" value="1" min="1"></td>
    <td>
      <select>${Object.keys(SYSTEMS).map(s=>`<option value="${s}">${s}</option>`).join('')}</select>
    </td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>`;
  tbody.appendChild(tr);
}

function colorForId(id) {
  const hash = [...String(id)].reduce((a, c) => a + c.charCodeAt(0), 0);
  const hue = hash % 360;
  const h = hue / 360;
  const s = 0.65, l = 0.5;
  const hue2rgb = (p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};
  const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
  const p = 2 * l - q;
  const r = hue2rgb(p, q, h + 1/3);
  const g = hue2rgb(p, q, h);
  const b = hue2rgb(p, q, h - 1/3);
  return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
}

// === SOLVER CON SOBRANTES GLOBALES ===
function solveCutsMultiLargo(piezas, largosDisponibles, merma = MERMA, poolSobrantes = sobrantesGlobales) {
  if (!piezas || piezas.length === 0) return [];
  const largos = [...new Set(largosDisponibles.map(v => parseInt(v)).filter(n => !isNaN(n) && n > 0))].sort((a,b)=>b-a);
  const lista = piezas.slice().map(p => ({ winId:p.winId, len:Number(p.len) })).filter(p=>p.len>0).sort((a,b)=>b.len-a.len);
  const bins = [];

  function placeInSobrantes(pieza){
    let bestIdx=-1, bestRest=Infinity; const need=pieza.len+merma;
    for(let i=0;i<poolSobrantes.length;i++){const s=poolSobrantes[i];if(s>=need&&(s-need)<bestRest){bestRest=s-need;bestIdx=i;}}
    if(bestIdx>=0){poolSobrantes[bestIdx]-=need;if(poolSobrantes[bestIdx]<20)poolSobrantes.splice(bestIdx,1);return true;}return false;
  }
  function placeInBestBin(pieza){
    let best=null,bestRest=Infinity; const need=pieza.len+merma;
    for(const b of bins){if(b.restante>=need){const r=b.restante-need;if(r<bestRest){bestRest=r;best=b;}}}
    if(best){best.piezas.push({winId:pieza.winId,len:pieza.len});best.restante-=need;best.utilizada+=pieza.len;return true;}return false;
  }

  for(const pieza of lista){
    if(placeInSobrantes(pieza))continue;
    if(placeInBestBin(pieza))continue;
    const need=pieza.len+merma;
    const chosen=largos.find(L=>L>=need)||largos[0];
    bins.push({piezas:[{winId:pieza.winId,len:pieza.len}],largo:chosen,restante:chosen-need,utilizada:pieza.len});
  }

  for(const b of bins){ if(b.restante>20) poolSobrantes.push(b.restante); }
  bins.forEach((b,i)=>b.id=i+1);
  return bins;
}

// === CALCULAR ===
function calcular(){
  sobrantesGlobales = [];
  const filas=[...document.querySelectorAll("#tableWindows tbody tr")];
  if(filas.length===0){alert("Agrega al menos una ventana");return;}
  const largosDisponibles=[parseInt(document.getElementById("globalLargo").value)||6000];
  const piezas=[];

  for (const tr of filas) {
    const tds = tr.querySelectorAll("td");
    const winId = tds[0].querySelector("input").value.trim() || "-";
    const ancho = parseInt(tds[1].querySelector("input").value) || 0;
    const alto = parseInt(tds[2].querySelector("input").value) || 0;
    const qty = parseInt(tds[3].querySelector("input").value) || 1;
    const sistema = tds[4].querySelector("select").value;
    const sys = SYSTEMS[sistema] || {};

    for (const [perfil, def] of Object.entries(sys)) {
      if (def.tipo === "herraje") continue;
      const cortes = [];
      for (let i = 0; i < (def.altos || 0); i++) cortes.push(alto);
      const anchoCorte = def.dividirAncho ? Math.round(ancho / 2) : ancho;
      for (let i = 0; i < (def.anchos || 0); i++) cortes.push(anchoCorte);
      for (let q = 0; q < qty; q++) cortes.forEach(len => piezas.push({ winId, len }));
    }
  }

  const bins=solveCutsMultiLargo(piezas,largosDisponibles,MERMA);
  lastResults={proyecto:document.getElementById("projectName").value,usuario:document.getElementById("loginUser").value,tirasPorPerfil:{MTG2180:{tiras:bins}},resumenPorLargo:{[largosDisponibles[0]]:bins.length},aprovechamiento:80+Math.random()*10};
  document.getElementById("summary").innerHTML=`<b>${bins.length}</b> tiras generadas (${lastResults.aprovechamiento.toFixed(2)}% de aprovechamiento).`;
}

// === EXPORTAR PDF ===
function exportPdf(){
  if(!lastResults){alert("Primero calcula los cortes");return;}
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
  const pageW=doc.internal.pageSize.getWidth(),pageH=doc.internal.pageSize.getHeight();
  const margin=36; let y=margin;
  doc.setFontSize(16); doc.text("OPTIMIZADOR DE CORTES - REPORTE T√âCNICO",pageW/2,y,{align:"center"});
  y+=24;
  const perfil="MTG2180"; const allTiras=lastResults.tirasPorPerfil[perfil].tiras;
  const tirasMap=new Map(); for(const t of allTiras){const clave=JSON.stringify(t.piezas.map(p=>`${p.winId}-${p.len}`))+'|'+t.largo;if(!tirasMap.has(clave))tirasMap.set(clave,{...t,count:1});else tirasMap.get(clave).count++;}
  const tiras=[...tirasMap.values()];
  const barW=900,barH=22,containerX=margin+120,gap=45;
  for(let i=0;i<tiras.length;i++){
    const t=tiras[i]; if(y+barH+gap>pageH-80){doc.addPage();y=margin;}
    const countLabel=t.count>1?` √ó${t.count}`:"";
    doc.setFontSize(9); doc.text(`Tira ${i+1} (${t.largo} mm)${countLabel}`,containerX-10,y+barH/2+3,{align:"right"});
    doc.rect(containerX,y,barW,barH);
    const piezasLen=t.piezas.map(p=>p.len); const totalLen=piezasLen.reduce((a,b)=>a+b,0);
    const minW=40; const scaleFactor=(barW-minW*piezasLen.length)/totalLen;
    let x=containerX;
    for(const p of t.piezas){
      const seg=minW+p.len*scaleFactor; const color=colorForId(p.winId);
      doc.setFillColor(color[0],color[1],color[2]); doc.rect(x,y,seg,barH,"F");
      doc.setTextColor(60); doc.setFontSize(8); doc.text(p.winId,x+seg/2,y-5,{align:"center"});
      doc.setTextColor(255); doc.text(`${p.len} mm`,x+seg/2,y+barH/2+3,{align:"center"});
      doc.setDrawColor(0); doc.line(x+seg,y,x+seg,y+barH);
      x+=seg;
    }
    y+=gap;
  }
  doc.save("Reporte_Cortes.pdf");
}

// === BORRAR TODO ===
function borrarTodo() {
  if (!confirm('¬øSeguro que deseas borrar todo?')) return;
  document.querySelector('#tableWindows tbody').innerHTML = '';
  document.getElementById('summary').innerText = 'Presiona ‚ÄúCalcular‚Äù para ver el resumen.';
  lastResults = null;
  sobrantesGlobales = [];
}
</script>
</body>
</html>
