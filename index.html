<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Optimizador Técnico de Cortes — Completo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h2 { text-align: center; }
    .login, .app { max-width: 1200px; margin: auto; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    input, select, button { padding: 5px; }
    .btn { background: #0069c0; color: #fff; border: none; border-radius: 5px; padding: 6px 10px; cursor: pointer; }
    .btn.ghost { background: #f44336; }
    .btn-group { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; }
    .hdr { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
    .resultado { background: #fff; padding: 10px; border-radius: 8px; margin-top: 15px; }
  </style>
</head>

<body>
  <!-- SECCIÓN DE LOGIN -->
  <div class="login" id="loginSection">
    <h2>Ingreso al Optimizador</h2>
    <label>Usuario:</label><br>
    <input type="text" id="loginUser" placeholder="Ingrese su usuario"><br><br>
    <label>Contraseña:</label><br>
    <input type="password" id="loginPass" placeholder="Ingrese la contraseña"><br><br>
    <button class="btn" id="loginBtn">Entrar</button>
  </div>

  <!-- SECCIÓN PRINCIPAL -->
  <div class="app hidden" id="appSection">
    <div class="hdr">
      <h2>Optimizador Técnico de Cortes</h2>
      <div id="hdrUser"></div>
    </div>

    <label>Largo estándar de perfil (mm):</label>
    <input type="number" id="globalLargo" value="6000" min="1000" step="100"><br><br>

    <div class="btn-group">
      <button class="btn" onclick="addRow()">Agregar ventana</button>
      <button class="btn" onclick="calcular()">Calcular resumen</button>
      <button class="btn ghost" onclick="borrarTodo()">Borrar todo</button>
      <button class="btn" onclick="generarPDF()">Exportar PDF</button>
    </div>

    <table id="tableWindows">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Ancho (mm)</th>
          <th>Alto (mm)</th>
          <th>Cantidad</th>
          <th>Sistema</th>
          <th>Largo Tira (mm)</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="resultado" class="resultado"></div>
  </div>

<script>
const PASSWORD = "1234";
let currentUser = null;
let lastResults = null;

const SYSTEMS = {
  "Corrediza Europea 3 Hojas": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 4, dividirAncho: true },
    "MTG2176": { altos: 4, anchos: 0 },
    "F04": { tipo: "herraje", calcularSegun: { "MTG2177": 2, "MTG2176": 1 } },
    "EUAA05L": { cantidad: 20, tipo: "herraje" },
    "EUAP01": { cantidad: 1.5, tipo: "herraje" },
    "EUCH01": { cantidad: 2, tipo: "herraje" },
    "EUCH02": { cantidad: 2, tipo: "herraje" },
  },
  "Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 4, tipo: "herraje" },
  },
  "Batiente": {},
  "Proyección": {},
  "Otro": {}
};

// LOGIN FUNCIONAL
document.getElementById('loginBtn').addEventListener('click', () => {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value;
  if (!user || !pass) {
    alert('Ingrese usuario y contraseña.');
    return;
  }
  if (pass !== PASSWORD) {
    alert('Contraseña incorrecta.');
    document.getElementById('loginPass').value = '';
    return;
  }

  // Login correcto
  currentUser = user;
  document.getElementById('hdrUser').innerText = `Usuario: ${user}`;
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('appSection').classList.remove('hidden');
  addRow();
});

function addRow() {
  const tbody = document.querySelector('#tableWindows tbody');
  const tr = document.createElement('tr');
  const defaultLargo = parseInt(document.getElementById('globalLargo').value) || 6000;
  tr.innerHTML = `
    <td><input type="text" placeholder="V1"></td>
    <td><input type="number" placeholder="1000"></td>
    <td><input type="number" placeholder="1500"></td>
    <td><input type="number" value="1" min="1"></td>
    <td><select>${Object.keys(SYSTEMS).map(s => `<option value="${s}">${s}</option>`).join('')}</select></td>
    <td><input type="number" value="${defaultLargo}" min="1000"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>`;
  tbody.appendChild(tr);
}

function borrarTodo() {
  if (confirm("¿Seguro que deseas borrar todos los datos?")) {
    document.querySelector('#tableWindows tbody').innerHTML = "";
    document.getElementById('resultado').innerHTML = "";
    lastResults = null;
  }
}

function calcular() {
  const filas = document.querySelectorAll('#tableWindows tbody tr');
  if (filas.length === 0) {
    alert("Agrega al menos una ventana.");
    return;
  }

  const resultados = {};
  filas.forEach(f => {
    const nombre = f.children[0].querySelector("input").value || "Sin nombre";
    const ancho = parseFloat(f.children[1].querySelector("input").value) || 0;
    const alto = parseFloat(f.children[2].querySelector("input").value) || 0;
    const cantidad = parseInt(f.children[3].querySelector("input").value) || 1;
    const sistema = f.children[4].querySelector("select").value;
    const largoTira = parseFloat(f.children[5].querySelector("input").value) || 6000;

    if (!resultados[sistema]) resultados[sistema] = { piezas: [], largoTira };
    resultados[sistema].piezas.push({ nombre, largo: ancho, alto, cantidad });
  });

  for (const [sistema, data] of Object.entries(resultados)) {
    const piezas = data.piezas.map(p => ({ nombre: p.nombre, largo: p.largo, cantidad: p.cantidad }));
    data.tiras = solveCuts(piezas, data.largoTira);
  }

  lastResults = resultados;
  document.getElementById('resultado').innerHTML = "✅ Cálculo completado. Listo para exportar PDF.";
}

// --- SOLVER OPTIMIZADO ---
function solveCuts(piezas, largoTira) {
  piezas = piezas.filter(p => p.largo > 0 && p.cantidad > 0);
  if (piezas.length === 0) return [];

  let todas = [];
  piezas.forEach(p => {
    for (let i = 0; i < p.cantidad; i++) todas.push({ nombre: p.nombre, largo: p.largo });
  });

  todas.sort((a, b) => b.largo - a.largo);

  let tiras = [];
  let sobrantes = [];

  for (const pieza of todas) {
    let colocada = false;
    let mejorAjuste = null;
    let menorRestante = Infinity;

    for (const s of sobrantes) {
      if (s.restante >= pieza.largo && s.restante - pieza.largo < menorRestante) {
        mejorAjuste = s;
        menorRestante = s.restante - pieza.largo;
      }
    }

    if (mejorAjuste) {
      mejorAjuste.piezas.push(pieza);
      mejorAjuste.restante -= pieza.largo;
      colocada = true;
    }

    if (!colocada) {
      const nuevaTira = { piezas: [pieza], restante: largoTira - pieza.largo };
      sobrantes.push(nuevaTira);
      tiras.push(nuevaTira);
    }
  }

  tiras.forEach((t, i) => {
    t.id = i + 1;
    t.utilizada = largoTira - t.restante;
  });

  return tiras;
}

// --- EXPORTAR PDF ---
function generarPDF() {
  if (!lastResults) {
    alert("Primero calcula los cortes.");
    return;
  }

  let totalUtil = 0, totalTira = 0;
  for (const data of Object.values(lastResults)) {
    for (const tira of data.tiras) {
      totalUtil += tira.utilizada;
      totalTira += data.largoTira;
    }
  }

  const aprovechamientoTotal = (totalUtil / totalTira) * 100;
  exportarPDF(lastResults, aprovechamientoTotal);
}

async function exportarPDF(resultados, aprovechamientoTotal) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
  const pageWidth = pdf.internal.pageSize.width;
  let y = 20;

  pdf.setFontSize(14);
  pdf.text("OPTIMIZADOR DE CORTES — Resumen", 15, y);
  y += 10;
  pdf.setFontSize(11);
  pdf.text(`Aprovechamiento total del material: ${aprovechamientoTotal.toFixed(2)}%`, 15, y);
  y += 8;

  for (const [perfil, data] of Object.entries(resultados)) {
    if (!data.tiras || data.tiras.length === 0) continue;
    pdf.setFontSize(12);
    pdf.text(`${perfil} — Diagramas de corte`, 15, y);
    y += 8;

    const largoTira = data.largoTira || 6000;
    const maxBarWidth = pageWidth - 40;

    for (const tira of data.tiras) {
      pdf.setFontSize(10);
      pdf.text(`Tira ${tira.id}`, 20, y);
      y += 5;

      let xStart = 35;
      const escala = maxBarWidth / largoTira;

      for (const p of tira.piezas) {
        const w = p.largo * escala;
        pdf.setFillColor(80, 200, 180);
        pdf.rect(xStart, y, w, 6, "F");
        pdf.setTextColor(255);
        pdf.setFontSize(8);
        pdf.text(`${p.nombre} - ${p.largo} mm`, xStart + 2, y + 4);
        xStart += w;
      }

      const sobranteW = tira.restante * escala;
      if (sobranteW > 0) {
        pdf.setFillColor(120);
        pdf.rect(xStart, y, sobranteW, 6, "F");
        pdf.setTextColor(255);
        pdf.setFontSize(8);
        pdf.text(`Sobrante ${tira.restante} mm`, xStart + 2, y + 4);
      }

      y += 10;
      pdf.setTextColor(0);
      pdf.setFontSize(9);
      pdf.text(`Tira utilizada: ${tira.utilizada} mm`, 35, y);
      y += 8;

      if (y > 180) {
        pdf.addPage();
        y = 20;
      }
    }
    y += 5;
  }
  pdf.save("Cortes_Optimizados.pdf");
}
</script>
</body>
</html>
