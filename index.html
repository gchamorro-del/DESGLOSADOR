<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Optimizador T√©cnico de Cortes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background: #f3f4f6;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #2f3e46;
    color: #fff;
    padding: 10px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  h1 { font-size: 20px; margin: 0; }
  .container {
    max-width: 1200px;
    margin: 20px auto;
    background: #fff;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 10px;
  }
  th, td {
    border: 1px solid #ccc;
    padding: 6px;
    text-align: center;
  }
  th { background: #e2e8f0; }
  input, select {
    width: 95%;
    padding: 4px;
    text-align: center;
  }
  button {
    background: #1b4332;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    margin: 5px;
    cursor: pointer;
  }
  button:hover { background: #40916c; }
  #summary {
    background: #f8fafc;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    padding: 10px;
    margin-top: 10px;
  }
  .login-box {
    max-width: 400px;
    margin: 100px auto;
    background: #fff;
    padding: 30px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
</style>
</head>
<body>

<header>
  <h1>üß∞ Optimizador T√©cnico de Cortes</h1>
  <div id="userInfo"></div>
</header>

<div id="loginSection" class="login-box">
  <h3>Ingreso de usuario</h3>
  <label>Usuario:</label><br>
  <input id="usuario" placeholder="T√©cnico o encargado"><br><br>
  <label>Contrase√±a:</label><br>
  <input id="clave" type="password" placeholder="********"><br><br>
  <button onclick="login()">Ingresar</button>
</div>

<div id="mainSection" class="container" style="display:none;">
  <h2>Datos del Proyecto</h2>
  <label>Cliente / Proyecto:</label>
  <input id="proyecto" placeholder="Ej. Edificio Aurora, Nivel 3" style="width:60%;margin-left:10px;"><br><br>

  <table id="windowTable">
    <thead>
      <tr>
        <th># Ventana</th>
        <th>Alto (mm)</th>
        <th>Ancho (mm)</th>
        <th>Cantidad</th>
        <th>Sistema</th>
        <th>Largo tira (mm)</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addRow()">‚ûï Agregar ventana</button>
  <button onclick="calculate()">‚öôÔ∏è Calcular</button>
  <button onclick="exportPDF()">üìÑ Exportar PDF</button>
  <button onclick="clearAll()">üßπ Borrar todo</button>

  <div id="summary"></div>
</div>

<script>
const MERMA = 3; // mm de merma por corte
const SYSTEMS = {
  "Eurovent": {
    "P1001": { altos: 2, anchos: 2 },
    "EUAA01": { tipo: "herraje", cantidad: 2 }
  },
  "Serie Espa√±ola": {
    "S2001": { altos: 2, anchos: 2 },
    "SEH01": { tipo: "herraje", cantidad: 1 }
  }
};

// ---- LOGIN ----
function login(){
  const u = document.getElementById('usuario').value.trim();
  const c = document.getElementById('clave').value.trim();
  if(!u || !c){ alert('Ingresa usuario y contrase√±a.'); return; }
  document.getElementById('loginSection').style.display='none';
  document.getElementById('mainSection').style.display='block';
  document.getElementById('userInfo').innerText = "üë∑ Usuario: " + u;
  window.currentUser = u;
}

// ---- AGREGAR FILAS ----
function addRow(){
  const tbody = document.querySelector("#windowTable tbody");
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input placeholder="V1"></td>
    <td><input type="number" min="1" step="1"></td>
    <td><input type="number" min="1" step="1"></td>
    <td><input type="number" min="1" step="1" value="1"></td>
    <td>
      <select>
        <option value="Eurovent">Eurovent</option>
        <option value="Serie Espa√±ola">Serie Espa√±ola</option>
      </select>
    </td>
    <td><input type="number" value="6000"></td>
    <td><button onclick="this.parentNode.parentNode.remove()">‚ùå</button></td>
  `;
  tbody.appendChild(tr);
}

// ---- CALCULAR ----
function packPieces(pieces, largoDisponible){
  let arr = pieces.map(x=>Number(x)).filter(x=>x>0).sort((a,b)=>b-a);
  let bins = [];
  arr.forEach(p=>{
    const need = p + MERMA;
    let placed = false;
    for(let b of bins){
      if(need <= b.remain){
        b.cortes.push(p);
        b.remain -= need;
        placed = true; break;
      }
    }
    if(!placed){
      let rem = largoDisponible - need;
      bins.push({ cortes:[p], remain:rem, largo:largoDisponible });
    }
  });
  return bins.map(b=>({ cortes:b.cortes, sobrante:b.remain, largo:b.largo }));
}

function calculate(){
  const rows = document.querySelectorAll("#windowTable tbody tr");
  if(rows.length===0){ alert("No hay ventanas."); return; }

  const piezasPorPerfilPorLargo = {};
  const herrajesTotales = {};
  const filasResumen = [];

  rows.forEach(r=>{
    const ventana = r.children[0].children[0].value.trim() || "Sin ID";
    const alto = parseFloat(r.children[1].children[0].value);
    const ancho = parseFloat(r.children[2].children[0].value);
    const qty = parseInt(r.children[3].children[0].value);
    const sistema = r.children[4].children[0].value;
    const largo = parseFloat(r.children[5].children[0].value);
    filasResumen.push({ ventana, alto, ancho, qty, sistema, largo });

    const perfiles = SYSTEMS[sistema] || {};
    Object.entries(perfiles).forEach(([code,def])=>{
      if(def.tipo==="herraje"){
        const u = (def.cantidad||1)*qty;
        herrajesTotales[code]=(herrajesTotales[code]||0)+u;
      } else {
        if(!piezasPorPerfilPorLargo[code]) piezasPorPerfilPorLargo[code]={};
        if(!piezasPorPerfilPorLargo[code][largo]) piezasPorPerfilPorLargo[code][largo]=[];
        for(let q=0;q<qty;q++){
          if(def.altos) for(let i=0;i<def.altos;i++) piezasPorPerfilPorLargo[code][largo].push({val:alto,win:ventana});
          if(def.anchos) for(let j=0;j<def.anchos;j++) piezasPorPerfilPorLargo[code][largo].push({val:ancho,win:ventana});
        }
      }
    });
  });

  const tirasPorPerfil = {};
  const resumenPorPerfil = {};
  for(const [perfil,map] of Object.entries(piezasPorPerfilPorLargo)){
    let todas=[];
    for(const [largo,piezas] of Object.entries(map)){
      const tiras=packPieces(piezas.map(p=>p.val),Number(largo));
      // vincular ventanas a cada corte
      tiras.forEach(t=>{
        t.winRefs=[];
        let idx=0;
        t.cortes.forEach(c=>{
          const ref=piezas[idx++];
          t.winRefs.push(ref?ref.win:"?");
        });
      });
      todas=todas.concat(tiras);
    }
    tirasPorPerfil[perfil]=todas;
    resumenPorPerfil[perfil]=todas.length;
  }

  window.lastResults={filas:filasResumen,tirasPorPerfil,herrajes:herrajesTotales,resumenPorPerfil,proyecto:document.getElementById('proyecto').value.trim(),usuario:window.currentUser};

  let html="<h3>üî¢ Resumen por perfil</h3>";
  for(const [p,n] of Object.entries(resumenPorPerfil)){ html+=`<p><b>${p}</b>: ${n} tiras</p>`; }
  for(const [h,n] of Object.entries(herrajesTotales)){ html+=`<p><b>${h}</b>: ${n} herrajes</p>`; }
  document.getElementById('summary').innerHTML=html;
}

// ---- PDF ----
function exportPDF(){
  if(!window.lastResults){ alert("Primero calcula."); return; }
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF({orientation:'landscape',unit:'pt',format:'a4'});
  const pageW=doc.internal.pageSize.getWidth(), margin=40; let y=margin;

  const d=window.lastResults;
  doc.setFontSize(14); doc.text('OPTIMIZADOR DE CORTES - REPORTE T√âCNICO', pageW/2, y, {align:'center'}); y+=18;
  doc.setFontSize(10);
  doc.text(`Proyecto: ${d.proyecto||'-'}`, margin, y); y+=12;
  doc.text(`Usuario: ${d.usuario||'-'}`, margin, y);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, pageW-220, y); y+=20;

  doc.setFontSize(12); doc.text('Listado de Ventanas:', margin, y); y+=12;
  doc.setFontSize(9);
  d.filas.forEach((f,i)=>{
    if(y>540){ doc.addPage(); y=margin; }
    doc.text(`${f.ventana} | ${f.sistema} | A:${f.alto} | L:${f.ancho} | Q:${f.qty}`, margin, y);
    y+=10;
  });

  y+=10;
  doc.setFontSize(12); doc.text('Diagramas de cortes:', margin, y); y+=14;

  const coloresVentanas = {};
  const colorPool = [[0,90,160],[200,50,50],[50,160,70],[200,130,0],[120,0,180],[80,80,80],[20,150,150]];

  function getColorForVentana(v){
    if(!coloresVentanas[v]){
      const idx=Object.keys(coloresVentanas).length % colorPool.length;
      coloresVentanas[v]=colorPool[idx];
    }
    return coloresVentanas[v];
  }

  const barMaxWidth=700, barH=14, gap=18;
  for(const [perfil,tiras] of Object.entries(d.tirasPorPerfil)){
    doc.setFontSize(11); doc.text(`${perfil} (${tiras.length} tiras)`, margin, y); y+=10;
    for(let ti=0;ti<tiras.length;ti++){
      const t=tiras[ti];
      const scale=(t.largo>0)?(barMaxWidth/t.largo):(barMaxWidth/6000);
      let x=margin+60, baseY=y;
      doc.setDrawColor(150); doc.rect(x,baseY,barMaxWidth,barH);
      for(let i=0;i<t.cortes.length;i++){
        const corte=t.cortes[i];
        const win=t.winRefs[i];
        const col=getColorForVentana(win);
        const seg=(corte+MERMA)*scale;
        doc.setFillColor(...col);
        doc.rect(x,baseY,seg,barH,'F');
        doc.setTextColor(255,255,255);
        if(seg>25) doc.text(`${win}: ${corte}`,x+seg/2,baseY+barH/2+3,{align:'center'});
        x+=seg;
      }
      y+=gap;
      if(y>540){ doc.addPage(); y=margin; }
    }
    y+=10;
  }

  doc.save('reporte_tecnico_cortes.pdf');
}

// ---- LIMPIAR ----
function clearAll(){
  document.querySelector("#windowTable tbody").innerHTML="";
  document.getElementById('summary').innerHTML="";
  window.lastResults=null;
}
</script>
</body>
</html>
