<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Optimizador de Cortes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .hidden { display: none; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin: 5px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid black; }
    th, td { padding: 5px; text-align: center; }
    button { margin: 5px; padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>

  <!-- Pantalla de login -->
  <div id="loginScreen">
    <h2>🔑 Ingresar</h2>
    <input type="password" id="password" placeholder="Contraseña">
    <button onclick="login()">Entrar</button>
  </div>

  <!-- Menú principal -->
  <div id="mainMenu" class="hidden">
    <h2>📋 Menú Principal</h2>
    <button onclick="showScreen('calcScreen')">Calcular Cortes</button>
    <button onclick="showScreen('sistemasScreen')">Ver Sistemas</button>
  </div>

  <!-- Pantalla de cálculo -->
  <div id="calcScreen" class="hidden">
    <h2>⚙️ Cálculo de Cortes</h2>
    <label>Alto (mm):</label>
    <input type="number" id="alto"><br>
    <label>Ancho (mm):</label>
    <input type="number" id="ancho"><br>
    <label>Largo de Tira Disponible (mm):</label>
    <input type="number" id="largoTira" value="6000"><br>
    <label>Sistema:</label>
    <select id="sistemaSelect"></select><br><br>
    <button onclick="calcular()">Calcular</button>
    <button onclick="generarPDF()">Exportar a PDF</button>
    <button onclick="showScreen('mainMenu')">🔙 Regresar</button>
    <div id="resultado"></div>
  </div>

  <!-- Pantalla de sistemas -->
  <div id="sistemasScreen" class="hidden">
    <h2>🛠️ Sistemas Registrados</h2>
    <div id="sistemasList"></div>
    <button onclick="showScreen('mainMenu')">🔙 Regresar</button>
  </div>

<script>
const MERMA = 150;
const PASSWORD = "1234"; // Contraseña

// Datos iniciales
let sistemas = JSON.parse(localStorage.getItem("sistemas")) || {
  "Ventana Corrediza Europea": [
    { codigo: "MTG1399", altos: 2, anchos: 2 },
    { codigo: "MTG2177", altos: 4, anchos: 2 },
    { codigo: "MTG2176", altos: 2 }
  ],
  "Ventana Fija": [
    { codigo: "MTG2180", altos: 2, anchos: 2 },
    { codigo: "MTG2184", altos: 2, anchos: 2 }
  ]
};

let ultimoResultado = null;

// Login
function login(){
  let pass = document.getElementById("password").value;
  if(pass === PASSWORD){
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("mainMenu").classList.remove("hidden");
    actualizarSistemas();
  } else {
    alert("Contraseña incorrecta");
  }
}

function showScreen(id){
  document.querySelectorAll("div").forEach(d => d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
}

function actualizarSistemas(){
  let cont = document.getElementById("sistemasList");
  let sel = document.getElementById("sistemaSelect");
  cont.innerHTML = "";
  sel.innerHTML = "";

  Object.keys(sistemas).forEach(nombre => {
    cont.innerHTML += `<div class="card"><b>${nombre}</b><br>Perfiles: ${sistemas[nombre].map(p=>p.codigo).join(", ")}</div>`;
    sel.innerHTML += `<option value="${nombre}">${nombre}</option>`;
  });

  localStorage.setItem("sistemas", JSON.stringify(sistemas));
}

function calcular(){
  let alto = parseInt(document.getElementById("alto").value);
  let ancho = parseInt(document.getElementById("ancho").value);
  let largoTira = parseInt(document.getElementById("largoTira").value);
  let sistema = document.getElementById("sistemaSelect").value;

  ultimoResultado = calcularSistema(alto, ancho, largoTira, sistemas[sistema]);
  mostrarResultado(ultimoResultado);
}

function calcularSistema(alto, ancho, largoTira, perfiles){
  let resultado = {};
  
  perfiles.forEach(perfil => {
    let cortes = [];

    if(perfil.altos){
      for(let i=0; i<perfil.altos; i++){
        cortes.push(alto + MERMA);
      }
    }

    if(perfil.anchos){
      for(let i=0; i<perfil.anchos; i++){
        cortes.push(ancho + MERMA);
      }
    }

    // Optimización detallada
    let tiras = [];
    let sobrante = largoTira;
    let actual = [];

    cortes.forEach(c => {
      if(c <= sobrante){
        actual.push(c);
        sobrante -= c;
      } else {
        tiras.push({ cortes: actual, sobrante });
        actual = [c];
        sobrante = largoTira - c;
      }
    });
    tiras.push({ cortes: actual, sobrante });

    resultado[perfil.codigo] = { tiras };
  });

  return resultado;
}

function mostrarResultado(resultado){
  let html = `<h2>🔢 Resumen Global</h2>`;

  Object.keys(resultado).forEach(codigo => {
    html += `<p>Total tiras ${codigo} = ${resultado[codigo].tiras.length}</p>`;
  });

  Object.keys(resultado).forEach(codigo => {
    let tiras = resultado[codigo].tiras;
    html += `<h3>Perfil ${codigo} → Total de tiras: ${tiras.length}</h3>`;
    html += "<table><tr><th># Tira</th><th>Cortes (mm)</th><th>Sobrante (mm)</th></tr>";
    tiras.forEach((t, i) => {
      html += `<tr>
        <td>${i+1}</td>
        <td>${t.cortes.join(", ")}</td>
        <td>${t.sobrante}</td>
      </tr>`;
    });
    html += "</table><br>";
  });

  document.getElementById("resultado").innerHTML = html;
}

// Exportar PDF con resumen
function generarPDF(){
  if(!ultimoResultado){ alert("Primero haz un cálculo."); return; }

  const { jsPDF } = window.jspdf;
  let doc = new jsPDF();
  let y = 20;

  doc.setFontSize(14);
  doc.text("Reporte de Optimización de Cortes", 20, y);
  y += 10;

  // Resumen global por perfil
  doc.setFontSize(12);
  doc.text("🔢 Resumen Global:", 20, y);
  y += 8;

  Object.keys(ultimoResultado).forEach(codigo => {
    doc.text(`Total tiras ${codigo} = ${ultimoResultado[codigo].tiras.length}`, 20, y);
    y += 6;
  });

  y += 10;

  // Detalle por perfil
  Object.keys(ultimoResultado).forEach(codigo => {
    let tiras = ultimoResultado[codigo].tiras;

    doc.setFontSize(12);
    doc.text(`Perfil ${codigo} → Total de tiras: ${tiras.length}`, 20, y);
    y += 8;

    doc.setFontSize(10);
    doc.text("Tira", 20, y);
    doc.text("Cortes (mm)", 50, y);
    doc.text("Sobrante (mm)", 150, y);
    y += 5;

    tiras.forEach((t, i) => {
      doc.text(String(i+1), 20, y);
      doc.text(t.cortes.join(", "), 50, y);
      doc.text(String(t.sobrante), 150, y);
      y += 5;

      if(y > 270){
        doc.addPage();
        y = 20;
      }
    });

    y += 10;
  });

  doc.save("optimizacion_detallada.pdf");
}
</script>

</body>
</html>
