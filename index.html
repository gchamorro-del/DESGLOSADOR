<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Optimizador de Cortes 2.0</title>
<style>
  body { font-family: Arial; margin: 20px; background:#f9f9f9; }
  .hidden { display: none; }
  .login, .menu, .admin, .calc { max-width: 800px; margin:auto; }
  input, select, button { padding: 8px; margin:5px 0; width:100%; }
  h2 { background:#333; color:#fff; padding:8px; border-radius:5px; }
  .perfil { border:1px solid #ccc; padding:8px; margin:5px 0; border-radius:5px; }
  table { border-collapse:collapse; width:100%; margin-top:10px; }
  th, td { border:1px solid #000; padding:6px; text-align:center; }
  .delete { color:red; cursor:pointer; margin-left:10px; }
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login">
  <h2>Acceso</h2>
  <input type="password" id="pass" placeholder="Contraseña">
  <button onclick="login()">Entrar</button>
</div>

<!-- MENÚ PRINCIPAL -->
<div class="menu hidden">
  <h2>Menú principal</h2>
  <button onclick="showAdmin()">Administrar sistemas</button>
  <button onclick="showCalc()">Calcular tiras</button>
</div>

<!-- ADMINISTRACIÓN -->
<div class="admin hidden">
  <h2>Administrar sistemas</h2>
  <input type="text" id="sistemaNombre" placeholder="Nombre del sistema">
  <button onclick="agregarSistema()">Agregar sistema</button>
  <h3>Sistemas registrados</h3>
  <div id="listaSistemas"></div>
  <button onclick="backMenu()">Volver</button>
</div>

<!-- CÁLCULO -->
<div class="calc hidden">
  <h2>Calcular tiras</h2>
  <label>Sistema:</label>
  <select id="sistemaSelect"></select>
  <input type="number" id="alto" placeholder="Alto (mm)">
  <input type="number" id="ancho" placeholder="Ancho (mm)">
  <input type="number" id="largoTira" placeholder="Largo de la tira disponible (mm)" value="6000">
  <button onclick="calcular()">Calcular</button>
  <button onclick="generarPDF()">Generar PDF</button>
  <div id="resultado"></div>
  <button onclick="backMenu()">Volver</button>
</div>

<!-- Librería para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const PASSWORD = "1234"; // cámbiala
let sistemas = [];

// === LOGIN ===
function login(){
  if(document.getElementById("pass").value===PASSWORD){
    document.querySelector(".login").classList.add("hidden");
    document.querySelector(".menu").classList.remove("hidden");
    cargarDatos();
  } else {
    alert("Contraseña incorrecta");
  }
}

// === CAMBIO DE PANTALLAS ===
function showAdmin(){
  document.querySelector(".menu").classList.add("hidden");
  document.querySelector(".admin").classList.remove("hidden");
  mostrarSistemas();
}
function showCalc(){
  document.querySelector(".menu").classList.add("hidden");
  document.querySelector(".calc").classList.remove("hidden");
  actualizarSelect();
}
function backMenu(){
  document.querySelector(".admin").classList.add("hidden");
  document.querySelector(".calc").classList.add("hidden");
  document.querySelector(".menu").classList.remove("hidden");
}

// === SISTEMAS ===
function agregarSistema(){
  let nombre = document.getElementById("sistemaNombre").value;
  if(!nombre){alert("Escribe un nombre"); return;}
  sistemas.push({nombre, perfiles:[]});
  guardarDatos(); mostrarSistemas();
  document.getElementById("sistemaNombre").value="";
}

function agregarPerfil(index){
  let nombre = prompt("Nombre del perfil:");
  if(!nombre) return;
  let cortes = prompt("Cortes separados por coma (ej: alto,ancho,alto):");
  if(!cortes) return;
  let lista = cortes.split(",").map(x=>x.trim());
  sistemas[index].perfiles.push({nombre, cortes:lista});
  guardarDatos(); mostrarSistemas();
}

function eliminarSistema(i){
  if(confirm("¿Eliminar sistema completo?")){
    sistemas.splice(i,1); guardarDatos(); mostrarSistemas();
  }
}

function eliminarPerfil(si, pi){
  sistemas[si].perfiles.splice(pi,1); guardarDatos(); mostrarSistemas();
}

function mostrarSistemas(){
  let div = document.getElementById("listaSistemas");
  div.innerHTML="";
  sistemas.forEach((s, i)=>{
    let box=document.createElement("div");
    box.className="perfil";
    box.innerHTML=`<b>${s.nombre}</b> 
      <button onclick="agregarPerfil(${i})">Agregar perfil</button>
      <span class="delete" onclick="eliminarSistema(${i})">[Eliminar sistema]</span>`;
    let ul=document.createElement("ul");
    s.perfiles.forEach((p, j)=>{
      let li=document.createElement("li");
      li.innerHTML=`${p.nombre} (cortes: ${p.cortes.join(", ")})
        <span class="delete" onclick="eliminarPerfil(${i},${j})">[X]</span>`;
      ul.appendChild(li);
    });
    box.appendChild(ul); div.appendChild(box);
  });
}

// === GUARDAR Y CARGAR ===
function guardarDatos(){
  localStorage.setItem("sistemas", JSON.stringify(sistemas));
}
function cargarDatos(){
  let datos=localStorage.getItem("sistemas");
  if(datos) sistemas=JSON.parse(datos);
}

// === CÁLCULO ===
function actualizarSelect(){
  let sel=document.getElementById("sistemaSelect");
  sel.innerHTML="";
  sistemas.forEach((s,i)=>{
    let opt=document.createElement("option");
    opt.value=i; opt.textContent=s.nombre; sel.appendChild(opt);
  });
}

function calcular(){
  let si = document.getElementById("sistemaSelect").value;
  if(si===""){alert("Selecciona un sistema"); return;}
  let alto=parseInt(document.getElementById("alto").value);
  let ancho=parseInt(document.getElementById("ancho").value);
  let largoTira=parseInt(document.getElementById("largoTira").value);
  if(!alto||!ancho||!largoTira){alert("Completa los datos"); return;}
  
  let sistema=sistemas[si];
  let html=`<h3>Resultados para sistema: ${sistema.nombre}</h3>
    <table><tr><th>Perfil</th><th>Tiras necesarias</th><th>Sobrante última tira (mm)</th></tr>`;
  
  sistema.perfiles.forEach(p=>{
    let cortesNecesarios=p.cortes.map(c=>c==="alto"?alto:ancho);
    let tiras=1, sobrante=largoTira;
    cortesNecesarios.forEach(c=>{
      if(c<=sobrante){sobrante-=c;}
      else{tiras++; sobrante=largoTira-c;}
    });
    html+=`<tr><td>${p.nombre}</td><td>${tiras}</td><td>${sobrante}</td></tr>`;
  });
  html+="</table>";
  document.getElementById("resultado").innerHTML=html;
}

// === PDF ===
function generarPDF(){
  const { jsPDF } = window.jspdf;
  let doc=new jsPDF();
  doc.setFontSize(14);
  doc.text("Reporte de Optimización", 10, 10);
  
  let y=20;
  sistemas.forEach(s=>{
    doc.setFontSize(12);
    doc.text(`Sistema: ${s.nombre}`, 10, y); y+=8;
    doc.setFontSize(10);
    doc.text("Perfil | Tiras | Sobrante", 10, y); y+=6;
    doc.line(10, y, 200, y); y+=4;
    
    s.perfiles.forEach(p=>{
      doc.text(`${p.nombre}`, 10, y);
      doc.text("...", 70, y); // lugar de cálculo en PDF
      y+=6;
    });
    y+=6;
  });
  
  doc.save("reporte_sistemas.pdf");
}
</script>
</body>
</html>
