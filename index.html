<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Cortes y Herrajes</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #004aad;
      color: white;
      padding: 15px;
      text-align: center;
    }
    main {
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    input, select, button {
      margin: 8px 0;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background-color: #004aad;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #003080;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #004aad;
      color: white;
    }
    .diagram {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 20px;
    }
    .bar {
      display: flex;
      height: 40px;
      border: 1px solid #333;
      background-color: #e0e0e0;
      position: relative;
      overflow: hidden;
    }
    .cut {
      height: 100%;
      text-align: center;
      font-size: 12px;
      line-height: 40px;
      color: white;
    }
    .cut:nth-child(odd) {
      background-color: #004aad;
    }
    .cut:nth-child(even) {
      background-color: #007bff;
    }
  </style>
</head>
<body>
  <header>
    <h1>Calculadora de Cortes y Herrajes</h1>
  </header>

  <main>
    <label for="projectName">Nombre del proyecto:</label>
    <input type="text" id="projectName" placeholder="Ej. Ventana corrediza 3 hojas">

    <label for="systemSelect">Selecciona el sistema:</label>
    <select id="systemSelect">
      <option value="">Seleccione...</option>
      <option value="Corrdiza Europea 3 Hojas">Corrediza Europea 3 Hojas</option>
    </select>

    <label for="ancho">Ancho (mm):</label>
    <input type="number" id="ancho" placeholder="Ej. 2000">

    <label for="alto">Alto (mm):</label>
    <input type="number" id="alto" placeholder="Ej. 1500">

    <label for="cantidad">Cantidad:</label>
    <input type="number" id="cantidad" value="1" min="1">

    <label for="tiraLargo">Largo disponible de tira (mm):</label>
    <input type="number" id="tiraLargo" value="6000" min="1000">

    <button id="addWindow">Agregar ventana</button>
    <button id="generatePDF">Generar PDF</button>

    <h2>Resumen de cortes</h2>
    <table id="cutsTable">
      <thead>
        <tr>
          <th>Perfil</th>
          <th>Longitudes (mm)</th>
          <th>Total (mm)</th>
          <th>Tiras usadas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Resumen de herrajes</h2>
    <table id="hardwareTable">
      <thead>
        <tr>
          <th>Herraje</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>Diagrama de cortes</h2>
    <div class="diagram" id="diagramContainer"></div>
  </main>

  <script>
    const SYSTEMS = {
      "Corrdiza Europea 3 Hojas": {
        "MTG1399": { altos: 2, anchos: 2 },
        "MTG2177": { altos: 6, anchos: 6, dividirAncho: true },
        "MTG2176": { altos: 4, anchos: 0 },
        "F04": { tipo: "herraje", calcularSegun: { "MTG2177": 2, "MTG2176": 1 } },
        "EUAA05L": { cantidad: 20, tipo: "herraje" },
        "EUAP01": { cantidad: 1.5, tipo: "herraje" },
        "EUCH01": { cantidad: 2, tipo: "herraje" },
        "EUCH02": { cantidad: 2, tipo: "herraje" },
      },
    };

    let ventanas = [];

    document.getElementById("addWindow").addEventListener("click", () => {
      const systemName = document.getElementById("systemSelect").value;
      const ancho = parseFloat(document.getElementById("ancho").value);
      const alto = parseFloat(document.getElementById("alto").value);
      const cantidad = parseInt(document.getElementById("cantidad").value);
      const tiraLargo = parseFloat(document.getElementById("tiraLargo").value);

      if (!systemName || !ancho || !alto || !cantidad) return alert("Complete todos los campos");

      const system = SYSTEMS[systemName];
      const cortes = {};
      const herrajes = {};

      Object.entries(system).forEach(([perfil, def]) => {
        if (def.tipo === "herraje") return;

        let cortesPerfil = [];
        for (let i = 0; i < (def.altos || 0); i++) cortesPerfil.push(alto);
        let anchoCorte = ancho;

        if (def.dividirAncho) {
          const divisor = typeof def.dividirAncho === "number" ? def.dividirAncho : 2;
          anchoCorte = ancho / divisor;
        }
        for (let j = 0; j < (def.anchos || 0); j++) cortesPerfil.push(anchoCorte);

        cortes[perfil] = (cortes[perfil] || []).concat(cortesPerfil.map(c => +(c * cantidad).toFixed(2)));
      });

      Object.entries(system).forEach(([nombre, def]) => {
        if (def.tipo === "herraje") {
          if (def.calcularSegun) {
            let total = 0;
            Object.entries(def.calcularSegun).forEach(([base, mult]) => {
              const totalML = (cortes[base] || []).reduce((a, b) => a + b, 0) / 1000;
              total += totalML * mult;
            });
            herrajes[nombre] = +(total.toFixed(2));
          } else {
            herrajes[nombre] = +(def.cantidad * cantidad).toFixed(2);
          }
        }
      });

      ventanas.push({ systemName, cortes, herrajes, tiraLargo });
      renderTables();
    });

    function renderTables() {
      const cutsTable = document.querySelector("#cutsTable tbody");
      const hardwareTable = document.querySelector("#hardwareTable tbody");
      const diagramContainer = document.getElementById("diagramContainer");
      cutsTable.innerHTML = "";
      hardwareTable.innerHTML = "";
      diagramContainer.innerHTML = "";

      const cortesTotales = {};
      const herrajesTotales = {};

      ventanas.forEach(v => {
        Object.entries(v.cortes).forEach(([perfil, arr]) => {
          cortesTotales[perfil] = (cortesTotales[perfil] || []).concat(arr);
        });
        Object.entries(v.herrajes).forEach(([h, q]) => {
          herrajesTotales[h] = (herrajesTotales[h] || 0) + q;
        });
      });

      Object.entries(cortesTotales).forEach(([perfil, arr]) => {
        const total = arr.reduce((a, b) => a + b, 0);
        const tiras = Math.ceil(total / ventanas[0].tiraLargo);
        cutsTable.innerHTML += `
          <tr>
            <td>${perfil}</td>
            <td>${arr.join(", ")}</td>
            <td>${total.toFixed(2)}</td>
            <td>${tiras}</td>
          </tr>`;
      });

      Object.entries(herrajesTotales).forEach(([h, q]) => {
        hardwareTable.innerHTML += `<tr><td>${h}</td><td>${q}</td></tr>`;
      });

      Object.entries(cortesTotales).forEach(([perfil, arr]) => {
        const bar = document.createElement("div");
        bar.className = "bar";
        const totalLength = ventanas[0].tiraLargo;
        arr.forEach((cut) => {
          const cutDiv = document.createElement("div");
          cutDiv.className = "cut";
          cutDiv.style.width = (cut / totalLength * 100) + "%";
          cutDiv.textContent = `${cut}`;
          bar.appendChild(cutDiv);
        });
        diagramContainer.appendChild(bar);
      });
    }
  </script>
</body>
</html>
