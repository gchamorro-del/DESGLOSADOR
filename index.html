<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Optimizador TÃ©cnico de Cortes (Final)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --bg:#111317;
    --panel:#1b1f23;
    --card:#0f1720;
    --text:#e6eef6;
    --muted:#98a2b3;
    --accent:#2ec4b6; /* verde-taller */
    --danger:#ef4444;
    --border:#2a2f33;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#0b0d0f, #0f1315);color:var(--text)}
  header{background:#071017;padding:14px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:18px;color:var(--accent)}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  .panel{background:linear-gradient(180deg,#0f1720,#0b1013);border-radius:10px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 24px rgba(0,0,0,0.6)}
  label{color:var(--muted);font-size:13px}
  input, select, button, textarea{font-size:14px}
  input[type="text"], input[type="number"], select, textarea{
    width:100%;padding:8px;border-radius:6px;border:1px solid #22303a;background:#071018;color:var(--text)
  }
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid var(--border);font-size:13px;color:var(--text);text-align:center;background:transparent}
  th{background:#071820;color:var(--muted)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#041018;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #2a3338;color:var(--text)}
  .btn.danger{background:var(--danger);color:#fff}
  #summary{margin-top:12px;padding:10px;border-radius:8px;border:1px solid var(--border);background:#071319;color:var(--text)}
  .muted{color:var(--muted);font-size:13px}
  .login-box{max-width:520px;margin:80px auto;padding:18px;border-radius:10px;background:linear-gradient(180deg,#071014,#081218);border:1px solid var(--border)}
  .center{text-align:center}
  .small{font-size:12px;color:var(--muted)}
  @media(max-width:860px){ .row{flex-direction:column} .col{width:100%} }
</style>
</head>
<body>
<header>
  <h1>ðŸ”© Optimizador TÃ©cnico de Cortes â€” VersiÃ³n Final</h1>
  <div id="hdrUser" class="small">Offline â€¢ Tema tÃ©cnico</div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginSection" class="login-box panel">
    <h2 style="color:var(--text);margin:0 0 8px 0">Acceso</h2>
    <div class="row" style="gap:8px">
      <div class="col">
        <label>Usuario (nombre):</label>
        <input id="loginUser" type="text" placeholder="Ej. Gustavo Chamorro">
      </div>
      <div style="width:180px">
        <label>ContraseÃ±a:</label>
        <input id="loginPass" type="password" placeholder="ContraseÃ±a">
      </div>
    </div>
    <div style="margin-top:12px" class="actions">
      <button class="btn" onclick="doLogin()">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">ContraseÃ±a fija por defecto: <b>1234</b></p>
  </div>

  <!-- APP -->
  <div id="appSection" style="display:none">
    <div class="panel">
      <div class="row" style="align-items:center;gap:12px">
        <div class="col">
          <label>Proyecto / Cliente</label>
          <input id="projectName" type="text" placeholder="Ej. Proyecto Alfa - Edificio A">
        </div>
        <div style="width:220px">
          <label>Largo disponible de tira (mm)</label>
          <input id="globalLargo" type="number" value="6000" min="1000">
        </div>
        <div style="width:220px">
          <label>&nbsp;</label>
          <div class="actions">
            <button class="btn" onclick="addRow()">âž• Agregar ventana</button>
            <button class="btn ghost" onclick="calcular()">ðŸ§® Calcular resumen</button>
            <button class="btn" onclick="exportPdf()">ðŸ“„ Exportar PDF</button>
            <button class="btn danger" onclick="borrarTodo()">ðŸ—‘ Borrar todo</button>
          </div>
        </div>
      </div>

      <h3 style="margin-top:14px;color:var(--accent)">Ventanas (ingreso manual)</h3>
      <p class="small muted">Ingrese ID de ventana (V1, V2...), Alto, Ancho, Cantidad y seleccione el sistema por fila.</p>

      <table id="tableWindows">
        <thead>
          <tr>
            <th style="width:90px">ID Ventana</th>
            <th>Alto (mm)</th>
            <th>Ancho (mm)</th>
            <th style="width:110px">Cantidad</th>
            <th style="width:220px">Sistema</th>
            <th style="width:120px">Largo Tira (mm)</th>
            <th style="width:80px">Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="summary" class="muted center">Presiona "Calcular resumen" para ver totales por perfil.</div>
    </div>
  </div>
</div>

<script>
/* ----------------- CONFIG y DATOS ----------------- */
const PASSWORD = "1234";
const MERMA = 50; // mm por corte, como definiste
const SYSTEMS = {
  "Corrediza Europea 3 VIAS": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 2 },
    "MTG2176": { altos: 2, anchos: 0 },
    "EUAA01": { cantidad: 1, tipo: "herraje" }
  },
  "Fija Europea": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 1, tipo: "herraje" }
  },
  "Corrediza Europea 3 VIAS CON CEDAZO  ": {},
  "Abatible": {},
  "Corrediza Europea 2 VIAS": {},
  "Proyectable": {}
};

/* ----------------- ESTADO ----------------- */
let lastResults = null;
let currentUser = null;

/* ----------------- UTIL: limpiar texto para filename ----------------- */
function sanitizeFilename(s){
  return s.replace(/[^a-z0-9_\-]/gi,'_').substring(0,80);
}

/* ----------------- LOGIN ----------------- */
function doLogin(){
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u || !p){ alert('Ingrese usuario y contraseÃ±a'); return; }
  if(p !== PASSWORD){ alert('ContraseÃ±a incorrecta'); return; }
  currentUser = u;
  document.getElementById('hdrUser').innerText = `Usuario: ${u}`;
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('appSection').style.display = 'block';
  addRow(); // fila inicial
}

/* ----------------- INTERFAZ FILAS ----------------- */
function addRow(){
  const tbody = document.querySelector('#tableWindows tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" placeholder="V1"></td>
    <td><input type="number" min="1" step="1" placeholder="1200"></td>
    <td><input type="number" min="1" step="1" placeholder="800"></td>
    <td><input type="number" min="1" step="1" value="1"></td>
    <td>
      <select>
        ${Object.keys(SYSTEMS).map(s=>`<option value="${s}">${s}</option>`).join('')}
      </select>
    </td>
    <td><input type="number" min="1000" step="1" value="${document.getElementById('globalLargo').value || 6000}"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>
  `;
  tbody.appendChild(tr);
}

/* ----------------- PACKING (objetos con ventana ref) ----------------- */
/* empaqueta piezas objetos: {val: mm, win: 'V1'} */
function packPiecesObjects(piecesObj, largoDisponible){
  // piezasObj: array of {val, win}
  if(!Array.isArray(piecesObj)) piecesObj=[];
  // ordenar descendente por val
  let arr = piecesObj.slice().filter(p=>Number(p.val)>0).sort((a,b)=>b.val - a.val);
  let bins = []; // { remain, cortes: [vals], winRefs: [], largo }

  arr.forEach(p=>{
    const need = p.val + MERMA;
    let placed=false;
    for(let b of bins){
      if(need <= b.remain){
        b.cortes.push(p.val);
        b.winRefs.push(p.win);
        b.remain -= need;
        placed=true; break;
      }
    }
    if(!placed){
      let rem = largoDisponible - need;
      if(rem < 0) rem = 0;
      bins.push({ cortes:[p.val], winRefs:[p.win], remain:rem, largo:largoDisponible });
    }
  });

  // mejora local limitada (intento de mover piezas)
  let improved=true, iter=0;
  while(improved && iter<6){
    improved=false; iter++;
    bins.sort((a,b)=>a.remain - b.remain);
    for(let i=0;i<bins.length;i++){
      let target=bins[i];
      if(target.remain<=0) continue;
      let found=null;
      for(let j=bins.length-1;j>=0;j--){
        if(j===i) continue;
        for(let k=0;k<bins[j].cortes.length;k++){
          let piece = bins[j].cortes[k];
          let need = piece + MERMA;
          if(need <= target.remain){
            found={from:j,pos:k,piece};
            break;
          }
        }
        if(found) break;
      }
      if(found){
        // mover pieza
        const movedWin = bins[found.from].winRefs[found.pos];
        bins[found.from].cortes.splice(found.pos,1);
        bins[found.from].winRefs.splice(found.pos,1);
        bins[found.from].remain += found.piece + MERMA;
        target.cortes.push(found.piece);
        target.winRefs.push(movedWin);
        target.remain -= found.piece + MERMA;
        // eliminar bins vacÃ­os
        for(let b=bins.length-1;b>=0;b--) if(bins[b].cortes.length===0) bins.splice(b,1);
        improved=true; break;
      }
    }
  }

  return bins.map(b=>({ cortes: b.cortes.slice(), winRefs: b.winRefs.slice(), sobrante: Math.max(0,b.remain), largo: b.largo }));
}

/* ----------------- CALCULAR: genera piezas por perfil y empaqueta ----------------- */
function calcular(){
  document.getElementById('summary').innerHTML = '<div class="muted center">Calculando...</div>';
  const rows = Array.from(document.querySelectorAll('#tableWindows tbody tr'));
  if(rows.length===0){ alert('Agrega al menos una ventana.'); document.getElementById('summary').innerHTML=''; return; }

  const piezasPorPerfilPorLargo = {}; // perfil -> { largo: [ {val,win}, ... ] }
  const herrajes = {}; // perfil_herraje -> total unidades
  const filasList = [];

  rows.forEach(r=>{
    const winId = (r.children[0].children[0].value || '').trim() || 'SinID';
    const alto = Number(r.children[1].children[0].value) || 0;
    const ancho = Number(r.children[2].children[0].value) || 0;
    const qty = Math.max(1, Number(r.children[3].children[0].value) || 1);
    const sistema = r.children[4].children[0].value;
    const largo = Number(r.children[5].children[0].value) || Number(document.getElementById('globalLargo').value) || 6000;

    filasList.push({ winId, alto, ancho, qty, sistema, largo });

    if(!alto || !ancho) return; // ignorar incompletos

    const perfiles = SYSTEMS[sistema] || {};
    Object.entries(perfiles).forEach(([perfil, def])=>{
      if(def && def.tipo === 'herraje'){
        const unidades = (def.cantidad || 1) * qty;
        herrajes[perfil] = (herrajes[perfil] || 0) + unidades;
      } else {
        if(!piezasPorPerfilPorLargo[perfil]) piezasPorPerfilPorLargo[perfil] = {};
        if(!piezasPorPerfilPorLargo[perfil][largo]) piezasPorPerfilPorLargo[perfil][largo] = [];
        for(let k=0;k<qty;k++){
          if(def.altos) for(let a=0;a<def.altos;a++) piezasPorPerfilPorLargo[perfil][largo].push({val: alto, win: winId});
          if(def.anchos) for(let b=0;b<def.anchos;b++) piezasPorPerfilPorLargo[perfil][largo].push({val: ancho, win: winId});
        }
      }
    });
  });

  // empaquetado por perfil y por cada largo
  const tirasPorPerfil = {};
  const resumenPorPerfil = {};
  Object.entries(piezasPorPerfilPorLargo).forEach(([perfil, mapL])=>{
    let todas = [];
    Object.entries(mapL).forEach(([largoKey, piezas])=>{
      const largoNum = Number(largoKey);
      if(!piezas || piezas.length===0) return;
      const tiras = packPiecesObjects(piezas, largoNum);
      // tiras contienen winRefs
      todas = todas.concat(tiras);
    });
    tirasPorPerfil[perfil] = todas;
    resumenPorPerfil[perfil] = todas.length;
  });

  // agrupar resumen por sistema para pantalla
  const resumenPorSistema = {};
  Object.entries(resumenPorPerfil).forEach(([perfil, n])=>{
    let sysFound = null;
    for(const s of Object.keys(SYSTEMS)){
      if(SYSTEMS[s] && SYSTEMS[s][perfil]) { sysFound = s; break; }
    }
    if(!sysFound) sysFound = 'Otros';
    if(!resumenPorSistema[sysFound]) resumenPorSistema[sysFound] = {};
    resumenPorSistema[sysFound][perfil] = n;
  });

  lastResults = {
    proyecto: document.getElementById('projectName').value.trim(),
    usuario: currentUser,
    filas: filasList,
    resumenPorPerfil,
    tirasPorPerfil,
    herrajes,
    resumenPorSistema
  };

  // mostrar solo resumen por pantalla (por sistema y perfil)
  let html = '<h3 style="color:var(--accent)">ðŸ”¢ Resumen global (totales por perfil)</h3>';
  Object.entries(lastResults.resumenPorSistema).forEach(([sys, profiles])=>{
    html += `<div style="text-align:left;margin-top:6px"><b>${sys}</b><ul style="margin:6px 0 8px 18px">`;
    Object.entries(profiles).forEach(([code, n])=>{
      html += `<li>${code} = <b>${n}</b> tiras</li>`;
    });
    html += `</ul></div>`;
  });
  if(Object.keys(lastResults.herrajes).length){
    html += `<div style="text-align:left;margin-top:6px"><b>Herrajes (unidades)</b><ul style="margin:6px 0 8px 18px">`;
    Object.entries(lastResults.herrajes).forEach(([h,n])=> html += `<li>${h} = <b>${n}</b></li>`);
    html += `</ul></div>`;
  }
  document.getElementById('summary').innerHTML = html;
}

/* ----------------- ASIGNAR COLOR DETERMINISTA POR IDVENTANA ----------------- */
const PALETTE = [
  [38,166,154],[3,169,244],[255,138,101],[156,39,176],[255,193,7],
  [76,175,80],[233,30,99],[96,125,139],[0,188,212],[205,220,57]
];
function colorForId(id){
  // hash string to index
  let h=0;
  for(let i=0;i<id.length;i++) h = (h<<5)-h + id.charCodeAt(i);
  const idx = Math.abs(h) % PALETTE.length;
  return PALETTE[idx];
}

/* ----------------- EXPORTAR PDF (APAI SADO / landscape) ----------------- */
function exportPdf(){
  if(!lastResults){ alert('Calcula primero antes de exportar.'); return; }
  const data = lastResults;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit:'pt', format:'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 36;
  let y = margin;

  // header
  doc.setFontSize(16); doc.setTextColor(0,0,0);
  doc.text('OPTIMIZADOR DE CORTES - REPORTE TÃ‰CNICO', pageW/2, y, {align:'center'});
  y += 18;
  doc.setFontSize(10); doc.setTextColor(0,0,0);
  doc.text(`Proyecto: ${data.proyecto || '-'}`, margin, y);
  doc.text(`Usuario: ${data.usuario || '-'}`, margin + 300, y);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, pageW - margin - 160, y);
  y += 16;

  // listado ventanas
  doc.setFontSize(11); doc.setTextColor(0,0,0);
  doc.text('Listado de ventanas ingresadas:', margin, y); y += 12;
  doc.setFontSize(9);
  if(Array.isArray(data.filas) && data.filas.length){
    data.filas.forEach((f,i)=>{
      if(y > pageH - 100){ doc.addPage(); y = margin; }
      doc.text(`${i+1}. ${f.winId} | ${f.sistema} | Alto:${f.alto} | Ancho:${f.ancho} | Cant:${f.qty}`, margin, y);
      y += 10;
    });
  } else {
    doc.text('No hay ventanas registradas.', margin, y); y += 12;
  }

  y += 10;
  // resumen por perfil
  doc.setFontSize(11); doc.text('Resumen por perfil (tiras):', margin, y); y += 12;
  doc.setFontSize(9);
  Object.entries(data.resumenPorPerfil || {}).forEach(([p,n])=>{
    if(y > pageH - 100){ doc.addPage(); y = margin; }
    doc.text(`${p} = ${n} tiras`, margin, y);
    y += 10;
  });

  y += 8;
  // herrajes
  if(Object.keys(data.herrajes || {}).length){
    doc.setFontSize(11); doc.text('Herrajes (unidades):', margin, y); y += 12;
    doc.setFontSize(9);
    Object.entries(data.herrajes).forEach(([h,n])=>{
      if(y > pageH - 100){ doc.addPage(); y = margin; }
      doc.text(`${h} = ${n} unidades`, margin, y);
      y += 10;
    });
    y += 8;
  }

  // diagramas por perfil (cada tira como barra horizontal)
  doc.setFontSize(12); doc.text('Diagramas de cortes por perfil (colores por ventana):', margin, y); y += 14;
  const barMaxWidth = Math.min(pageW - margin*2 - 160, 900);
  const barH = 14;
  const gap = 18;

  const perfilCodes = Object.keys(data.tirasPorPerfil || {});
  for(const perfil of perfilCodes){
    if(y > pageH - 120){ doc.addPage(); y = margin; }
    doc.setFontSize(11); doc.setTextColor(200,200,200);
    doc.text(`${perfil} â€” Tiras: ${ (data.tirasPorPerfil[perfil]||[]).length }`, margin, y); y += 10;
    const tiras = data.tirasPorPerfil[perfil] || [];
    if(tiras.length === 0){
      doc.setFontSize(9); doc.text('No hay piezas para este perfil.', margin+10, y); y += 14;
      continue;
    }
    for(let ti=0; ti<tiras.length; ti++){
      if(y > pageH - 80){ doc.addPage(); y = margin; }
      const tira = tiras[ti];
      // escala por largo de esta tira
      const scale = (tira.largo && tira.largo>0) ? (barMaxWidth / tira.largo) : (barMaxWidth / 6000);
      let x = margin + 120; const baseY = y;
      // border
      doc.setDrawColor(120);
      doc.rect(x, baseY, barMaxWidth, barH);
      // dibujar cortes
      for(let ci=0; ci<tira.cortes.length; ci++){
        const corte = tira.cortes[ci];
        const win = (tira.winRefs && tira.winRefs[ci]) ? tira.winRefs[ci] : 'SinID';
        const color = colorForId(String(win));
        const seg = (corte + MERMA) * scale;
        doc.setFillColor(color[0], color[1], color[2]);
        doc.rect(x, baseY, seg, barH, 'F');
        // etiqueta: "V1 (MTG1399) = 1200 mm"
        const etiqueta = `${win} (${}) = ${corte} mm`;
        doc.setFontSize(8);
        // si el segmento es suficientemente ancho, escribir dentro; si no, escribir encima
        if(seg > 36){
          doc.setTextColor(255,255,255);
          doc.text(etiqueta, x + seg/2, baseY + barH/2 + 3, { align: 'center' });
        } else {
          doc.setTextColor(220,220,220);
          doc.text(etiqueta, x + seg/2, baseY - 2, { align: 'center' });
        }
        x += seg;
      }
      // sobrante
      if(tira.sobrante > 0){
        const sobraW = tira.sobrante * scale;
        doc.setFillColor(110,110,110);
        doc.rect(x, baseY, sobraW, barH, 'F');
        doc.setFontSize(8); doc.setTextColor(20,20,20);
        doc.text(`Sobrante ${tira.sobrante} mm`, x + Math.max(10, sobraW/2), baseY + barH/2 + 3, {align:'center'});
      }
      // left label
      doc.setFontSize(9); doc.setTextColor(50,50,50);
      doc.text(`Tira ${ti+1}`, margin + 20, baseY + barH/2 + 3);
      y += gap;
    }
    y += 8;
  }

  // fichero nombre automÃ¡tico
  const proj = sanitizeFilename(data.proyecto || 'Proyecto');
  const now = new Date();
  const stamp = now.getFullYear().toString() + String(now.getMonth()+1).padStart(2,'0') + String(now.getDate()).padStart(2,'0') + '_' + String(now.getHours()).padStart(2,'0') + String(now.getMinutes()).padStart(2,'0');
  const filename = `Cortes_${proj}_${stamp}.pdf`;
  doc.save(filename);
}

/* ----------------- BORRAR TODO ----------------- */
function borrarTodo(){
  if(!confirm('Borrar todas las filas y resultados?')) return;
  document.querySelector('#tableWindows tbody').innerHTML = '';
  document.getElementById('summary').innerHTML = 'Presiona "Calcular resumen" para ver totales por perfil.';
  lastResults = null;
}

/* ----------------- inicio: nada mÃ¡s cargar ----------------- */
document.addEventListener('DOMContentLoaded', ()=>{ /* nada mÃ¡s */ });
</script>
</body>
</html>

