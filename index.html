<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Optimizador TÃ©cnico de Cortes â€” Completo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1720; --text:#e6eef6; --muted:#98a2b3;
    --accent:#2ec4b6; --accent-2:#2b6df6; --danger:#ef4444; --border:#263039;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:linear-gradient(180deg,#071017,#071a2a);color:var(--text)}
  header{background:linear-gradient(90deg,var(--accent-2),#0366a6);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(0,0,0,0.2)}
  header h1{margin:0;font-size:18px;color:#fff}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  .panel{background:linear-gradient(180deg,#071820,#061017);border-radius:10px;padding:14px;border:1px solid var(--border)}
  label{color:var(--muted);font-size:13px}
  input, select, button, textarea{font-size:14px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #22303a;background:#071018;color:var(--text)}
  table{width:100%;border-collapse:collapse;margin-top:10px;background:transparent}
  th,td{padding:8px;border:1px solid rgba(255,255,255,0.03);font-size:13px;color:var(--text);text-align:center}
  th{background:rgba(255,255,255,0.03);color:var(--muted)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#041018;padding:8px 12px;border-radius:6px;border:none;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .btn.danger{background:var(--danger);color:#fff}
  #summary{margin-top:12px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,#071319,#061018);color:var(--text)}
  .muted{color:var(--muted);font-size:13px}
  .login-box{max-width:520px;margin:80px auto;padding:18px;border-radius:10px;background:linear-gradient(180deg,#071014,#081218);border:1px solid var(--border)}
  .center{text-align:center}
  .small{font-size:12px;color:var(--muted)}
  @media(max-width:860px){ .row{flex-direction:column} .col{width:100%} }
</style>
</head>
<body>
<header>
  <h1>ðŸ”© Optimizador TÃ©cnico de Cortes â€” VersiÃ³n Final</h1>
  <div id="hdrUser" class="small">Offline â€¢ Tema tÃ©cnico</div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginSection" class="login-box panel">
    <h2 style="color:var(--text);margin:0 0 8px 0">Acceso</h2>
    <div class="row" style="gap:8px">
      <div class="col">
        <label>Usuario (nombre):</label>
        <input id="loginUser" type="text" placeholder="Ej. Gustavo Chamorro">
      </div>
      <div style="width:180px">
        <label>ContraseÃ±a:</label>
        <input id="loginPass" type="password" placeholder="ContraseÃ±a">
      </div>
    </div>
    <div style="margin-top:12px" class="actions">
      <button class="btn" id="loginBtn">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">ContraseÃ±a fija por defecto: <b>1234</b></p>
  </div>

  <!-- APP -->
  <div id="appSection" style="display:none">
    <div class="panel">
      <div class="row" style="align-items:center;gap:12px">
        <div class="col">
          <label>Proyecto / Cliente</label>
          <input id="projectName" type="text" placeholder="Ej. Proyecto Alfa - Edificio A">
        </div>
        <div style="width:220px">
          <label>Largo disponible de tira (mm)</label>
          <input id="globalLargo" type="number" value="6000" min="1000">
        </div>
        <div style="width:220px">
          <label>&nbsp;</label>
          <div class="actions">
            <button class="btn" onclick="addRow()">âž• Agregar ventana</button>
            <button class="btn ghost" onclick="calcular()">ðŸ§® Calcular resumen</button>
            <button class="btn" onclick="exportPdf()">ðŸ“„ Exportar PDF</button>
            <button class="btn danger" onclick="borrarTodo()">ðŸ—‘ Borrar todo</button>
          </div>
        </div>
      </div>

      <h3 style="margin-top:14px;color:var(--accent)">Ventanas (ingreso manual)</h3>

      <!-- RESUMEN ARRIBA: solo tiras totales por perfil -->
      <div id="summary" class="muted center">Presiona "Calcular resumen" para ver totales por perfil.</div>

      <table id="tableWindows">
        <thead>
          <tr>
            <th>ID Ventana</th>
            <th>Ancho (mm)</th>
            <th>Alto (mm)</th>
            <th>Cantidad</th>
            <th>Sistema</th>
            <th>Largo Tira (mm)</th>
            <th>Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>
  </div>
</div>

<script>
/* ----------------- CONFIG ----------------- */
const PASSWORD = "1234";
const MERMA = 50; // merma por corte en mm
let currentUser = null;
let lastResults = null;

const SYSTEMS = {
  "Corrediza Europea 3 Hojas": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 4, dividirAncho: true },
    "MTG2176": { altos: 4, anchos: 0 },
    "F04": { tipo: "herraje", calcularSegun: { "MTG2177": 2, "MTG2176": 1 } },
    "EUAA05L": { cantidad: 20, tipo: "herraje" },
    "EUAP01": { cantidad: 1.5, tipo: "herraje" },
    "EUCH01": { cantidad: 2, tipo: "herraje" },
    "EUCH02": { cantidad: 2, tipo: "herraje" },
  },
  "Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 4, tipo: "herraje" },
  },
  "Batiente": {},
  "ProyecciÃ³n": {},
  "Otro": {}
};

/* ----------------- LOGIN ----------------- */
document.getElementById('loginBtn').addEventListener('click', () => {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  if(!u || !p){ alert('Ingrese usuario y contraseÃ±a'); return; }
  if(p !== PASSWORD){ alert('ContraseÃ±a incorrecta'); document.getElementById('loginPass').value = ''; return; }
  currentUser = u;
  document.getElementById('hdrUser').innerText = `Usuario: ${u}`;
  document.getElementById('loginSection').style.display = 'none';
  document.getElementById('appSection').style.display = 'block';
  addRow();
});

/* ----------------- INTERFAZ (tabla) ----------------- */
function addRow(){
  const tbody = document.querySelector('#tableWindows tbody');
  const tr = document.createElement('tr');
  const defaultLargo = parseInt(document.getElementById('globalLargo').value) || 6000;
  tr.innerHTML = `
    <td><input type="text" placeholder="V1"></td>
    <td><input type="number" placeholder="1000"></td>
    <td><input type="number" placeholder="1500"></td>
    <td><input type="number" value="1" min="1"></td>
    <td><select>${Object.keys(SYSTEMS).map(s=>`<option value="${s}">${s}</option>`).join('')}</select></td>
    <td><input type="number" value="${defaultLargo}" min="1000"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>
  `;
  tbody.appendChild(tr);
}

/* ----------------- SOLVER OPTIMIZADO (BFD con merma) ----------------- */
function solveCutsWithMerma(cortes, largoTira, merma = MERMA) {
  // cortes: array de longitudes (mm) *sin* merma. Retorna tiras: { piezas: [mm], restante, largo }
  if(!cortes || cortes.length === 0) return [];
  // piezas con merma para colocaciÃ³n, pero guardaremos longitudes reales en piezas
  const piezasConMerma = cortes.map(c => ({ real: c, colocadoLen: c + merma })).sort((a,b)=>b.colocadoLen - a.colocadoLen);
  const tiras = [];
  const sobrantes = []; // referencia a tiras para reutilizar

  for(const pieza of piezasConMerma){
    let mejor = null;
    let menorRest = Infinity;
    // buscar mejor ajuste en sobrantes existentes
    for(const t of sobrantes){
      if(t.restante >= pieza.colocadoLen && (t.restante - pieza.colocadoLen) < menorRest){
        mejor = t;
        menorRest = t.restante - pieza.colocadoLen;
      }
    }
    if(mejor){
      mejor.piezas.push(pieza.real);
      mejor.restante -= pieza.colocadoLen;
    } else {
      // crear nueva tira si cabe
      if(pieza.colocadoLen <= largoTira){
        const nueva = { piezas: [pieza.real], restante: largoTira - pieza.colocadoLen, largo: largoTira };
        sobrantes.push(nueva);
        tiras.push(nueva);
      } else {
        // pieza mayor que la tira (no cabe) -> la registramos como tira propia con sobrante negativo (informativo)
        const nueva = { piezas: [pieza.real], restante: 0, largo: pieza.colocadoLen };
        tiras.push(nueva);
      }
    }
  }

  // completar campos
  tiras.forEach((t,i)=>{
    t.id = i+1;
    t.utilizada = (t.largo || largoTira) - t.restante;
  });

  return tiras;
}

/* ----------------- CALCULAR (genera resumen de tiras totales por perfil) ----------------- */
function calcular(){
  const filas = [...document.querySelectorAll('#tableWindows tbody tr')];
  if(filas.length === 0){ alert('Agrega al menos una ventana'); return; }

  const resumenPorPerfil = {};      // cuenta de tiras por perfil
  const tirasPorPerfil = {};        // detalle de tiras (para PDF)
  let totalUsado = 0;
  let totalDisponible = 0;

  for(const tr of filas){
    const tds = tr.querySelectorAll('td');
    const winId = tds[0].querySelector('input').value.trim() || '-';
    const ancho = parseFloat(tds[1].querySelector('input').value) || 0;
    const alto = parseFloat(tds[2].querySelector('input').value) || 0;
    const qty = parseInt(tds[3].querySelector('input').value) || 1;
    const sistema = tds[4].querySelector('select').value;
    const largoTira = parseFloat(tds[5].querySelector('input').value) || 6000;

    const sys = SYSTEMS[sistema];
    if(!sys) continue;

    for(const [perfil, def] of Object.entries(sys)){
      // herrajes: ignoramos para resumen de tiras totales (no generan tiras)
      if(def.tipo === "herraje") continue;

      // construir cortes por perfil
      const cortesBase = [];
      for(let i=0;i<(def.altos||0);i++) cortesBase.push(alto);
      const anchoCorte = def.dividirAncho ? (ancho/2) : ancho;
      for(let j=0;j<(def.anchos||0);j++) cortesBase.push(anchoCorte);
      if(cortesBase.length === 0) continue;

      // replicar segÃºn cantidad
      const cortesTotales = [];
      for(let k=0;k<qty;k++) cortesTotales.push(...cortesBase);

      // resolver cortes (usamos el solver con merma)
      const tiras = solveCutsWithMerma(cortesTotales, largoTira, MERMA);

      resumenPorPerfil[perfil] = (resumenPorPerfil[perfil] || 0) + tiras.length;
      tirasPorPerfil[perfil] = tirasPorPerfil[perfil] || { tiras: [], largoTira };
      tiras.forEach(t => tirasPorPerfil[perfil].tiras.push(t));

      // contabilizar para aprovechamiento general
      tiras.forEach(t => {
        const largoUtil = (t.largo || largoTira) - MERMA;
        const usado = t.piezas.reduce((a,b)=>a+b,0);
        totalUsado += usado;
        totalDisponible += Math.max(largoUtil, 0);
      });
    }
  }

  const aprovechamiento = totalDisponible > 0 ? (totalUsado / totalDisponible) * 100 : 0;

  // guardar resultados
  lastResults = {
    proyecto: document.getElementById('projectName').value || '',
    usuario: currentUser,
    resumenPorPerfil,
    tirasPorPerfil,
    aprovechamiento
  };

  // mostrar resumen ARRIBA (solo tiras totales por perfil)
  let html = `<b>Resumen â€” Tiras totales por perfil</b><br>`;
  if(Object.keys(resumenPorPerfil).length === 0) html += '<span class="muted">No hay perfiles (tal vez solo herrajes o datos faltantes)</span>';
  else {
    Object.entries(resumenPorPerfil).forEach(([perfil, cant]) => {
      html += `${perfil}: ${cant} tiras<br>`;
    });
  }
  html += `<br><b>Aprovechamiento total:</b> ${aprovechamiento.toFixed(2)}%`;

  document.getElementById('summary').innerHTML = html;
}

/* ----------------- EXPORTAR PDF (landscape) ----------------- */
function exportPdf(){
  if(!lastResults){ alert('Calcula primero.'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 36;
  let y = margin;

  // Encabezado
  doc.setFontSize(16);
  doc.setTextColor(255,255,255);
  doc.text('OPTIMIZADOR DE CORTES - REPORTE TÃ‰CNICO', pageW/2, y, {align:'center'});
  y += 24;

  // Metadatos
  doc.setFontSize(10);
  doc.setTextColor(0,0,0);
  doc.text(`Proyecto: ${lastResults.proyecto || '-'}`, margin, y);
  doc.text(`Usuario: ${lastResults.usuario || '-'}`, margin + 300, y);
  doc.text(`Fecha: ${new Date().toLocaleString()}`, pageW - margin - 200, y);
  y += 18;

  // Resumen de tiras por perfil (arriba en PDF tambiÃ©n)
  doc.setFontSize(11);
  doc.text('RESUMEN - TIRAS TOTALES POR PERFIL', margin, y);
  y += 12;
  doc.setFontSize(9);
  const resumenEntries = Object.entries(lastResults.resumenPorPerfil || {});
  if(resumenEntries.length === 0){
    doc.text('No se registraron tiras.', margin, y); y += 12;
  } else {
    resumenEntries.forEach(([perfil, cant])=>{
      doc.text(`${perfil}: ${cant} tiras`, margin, y); y += 10;
    });
    y += 6;
  }

  // Aprovechamiento total
  doc.setFontSize(11);
  doc.setTextColor(0,100,0);
  doc.text(`Aprovechamiento total del material: ${lastResults.aprovechamiento.toFixed(2)}%`, margin, y);
  doc.setTextColor(0,0,0);
  y += 18;

  // Diagramas por perfil
  const barMaxWidth = Math.min(pageW - margin*2 - 200, 1000);
  const barH = 14;
  const gap = 36;

  const perfiles = Object.keys(lastResults.tirasPorPerfil || {});
  for(const perfil of perfiles){
    const obj = lastResults.tirasPorPerfil[perfil];
    if(!obj || !obj.tiras || obj.tiras.length === 0) continue;

    if(y > pageH - 120){ doc.addPage(); y = margin; }
    doc.setFontSize(12);
    doc.text(`${perfil} â€” Diagramas de corte`, margin, y);
    y += 12;

    const tiras = obj.tiras;
    const largoTira = obj.largoTira || (parseInt(document.getElementById('globalLargo').value) || 6000);

    tiras.forEach((tira, iT) => {
      if(y > pageH - 100){ doc.addPage(); y = margin; }
      const scale = barMaxWidth / (tira.largo || largoTira);
      let x = margin + 160;
      const baseY = y;

      doc.setFontSize(9);
      doc.text(`Tira ${iT+1}`, margin + 120, baseY + barH/2 + 3, {align:'right'});

      doc.setDrawColor(100);
      doc.rect(x, baseY, barMaxWidth, barH);

      let usadoMm = 0;
      for(let ci=0; ci<tira.piezas.length; ci++){
        const corte = tira.piezas[ci];
        const color = colorForId(String(ci));
        const seg = corte * scale;
        doc.setFillColor(color[0], color[1], color[2]);
        doc.rect(x, baseY, seg, barH, 'F');

        // etiqueta si hay espacio
        const etiqueta = `${corte} mm`;
        doc.setFontSize(7.5);
        if(seg > 36){
          doc.setTextColor(255,255,255);
          doc.text(etiqueta, x + seg/2, baseY + barH/2 + 3, {align:'center'});
        } else {
          doc.setTextColor(0,0,0);
          doc.text(`${corte} mm`, x + seg/2, baseY - 2, {align:'center'});
        }
        usadoMm += corte;
        x += seg;
      }

      // sobrante
      if(tira.restante > 0){
        const sobraW = tira.restante * scale;
        doc.setFillColor(120,120,120);
        doc.rect(x, baseY, sobraW, barH, 'F');
        doc.setFontSize(8);
        doc.setTextColor(0,0,0);
        doc.text(`Sobrante ${tira.restante} mm`, x + Math.max(10, sobraW/2), baseY + barH/2 + 3, {align:'center'});
      }

      // etiqueta de tira utilizada
      doc.setFontSize(8);
      doc.setTextColor(0,0,0);
      doc.text(`Tira utilizada: ${tira.utilizada} mm`, margin + barMaxWidth/2, baseY + barH + 14, {align:'center'});
      y += gap;
    });

    y += 8;
  }

  doc.save(`Cortes_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'_')}.pdf`);
}

/* ----------------- UTIL ----------------- */
function borrarTodo(){
  if(!confirm('Â¿Borrar todo?')) return;
  document.querySelector('#tableWindows tbody').innerHTML = '';
  lastResults = null;
  document.getElementById('summary').innerText = 'Presiona "Calcular resumen" para ver totales por perfil.';
}
</script>
</body>
</html>
