<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Optimizador de Cortes - Final</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--accent:#2b6ef6;--danger:#e55353;--muted:#666}
  body{font-family:Inter, Arial, Helvetica, sans-serif;background:var(--bg);color:#222;margin:14px}
  .wrap{max-width:1024px;margin:14px auto;padding:14px}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(33,33,33,0.06);margin-bottom:12px}
  h1,h2{margin:6px 0}
  label{display:block;font-size:13px;color:#333;margin-top:8px}
  input[type="number"], input[type="text"], select{width:100%;padding:8px;border:1px solid #d7d7d7;border-radius:8px;font-size:14px}
  /* quitar flechas en inputs number (Chrome/Edge/Firefox) */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  input[type=number] { -moz-appearance: textfield; }
  .btn { background:var(--accent); color:#fff; border:0; padding:8px 12px; border-radius:8px; cursor:pointer; margin-right:8px }
  .btn.ghost { background:#6c757d }
  .btn.danger { background:var(--danger) }
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e6e6e6;padding:8px;text-align:center;font-size:14px}
  th{background:#fafafa}
  .small{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .center{text-align:center}
  .muted{color:var(--muted);font-size:13px}
  .right{ text-align:right }
  .toolrow{display:flex;gap:10px;align-items:center}
  .inlinebtn{padding:6px 8px;border-radius:6px;border:0;background:#eee;cursor:pointer}
  @media(max-width:700px){ .row{flex-direction:column} .toolrow{flex-direction:column;align-items:stretch} }
</style>
</head>
<body>
<div class="wrap">
  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h1>üîê Acceso</h1>
    <p class="small">Introduce la contrase√±a para entrar al optimizador.</p>
    <input id="password" type="password" placeholder="Contrase√±a">
    <div style="margin-top:10px">
      <button class="btn" onclick="doLogin()">Entrar</button>
    </div>
    <p class="muted">Contrase√±a por defecto: <b>1234</b> (puedes cambiarla en el c√≥digo)</p>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="card">
      <h1>üîß Optimizador de Cortes - Multi-Ventanas</h1>
      <div class="row" style="align-items:end">
        <div class="col">
          <label>Sistema</label>
          <select id="sistemaSelect"></select>
        </div>
        <div class="col">
          <label>Largo disponible de la tira (mm)</label>
          <input id="largoTira" type="number" value="6000" placeholder="6000">
        </div>
        <div class="col">
          <label>&nbsp;</label>
          <div class="toolrow">
            <button class="btn" onclick="addRow()">+ Agregar ventana</button>
            <button class="btn ghost" onclick="calcular()">Calcular (mostrar resumen)</button>
            <button class="btn" onclick="exportPdfAll()">Exportar PDF</button>
            <button class="btn danger" onclick="clearAll()">üóë Borrar todo</button>
          </div>
        </div>
      </div>

      <h2 style="margin-top:16px">Ventanas (ingreso manual)</h2>
      <p class="small">Ingresa manualmente Alto, Ancho y Cantidad. No uses las flechas ‚Äî los inputs est√°n configurados para entrada directa.</p>

      <table id="tablaVentanas">
        <thead>
          <tr><th style="width:40px">#</th><th>Alto (mm)</th><th>Ancho (mm)</th><th style="width:120px">Cantidad</th><th style="width:120px">Acci√≥n</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="resumenBox" style="margin-top:14px"></div>
      <p class="muted" style="margin-top:8px">Nota: Al presionar "Calcular" aparecer√° √∫nicamente el resumen global de tiras por perfil. Los diagramas y detalle salen solo en el PDF.</p>
    </div>
  </div>
</div>

<script>
/* ------------ Configuraci√≥n ------------ */
const PASSWORD = "1234"; // contrase√±a fija
const MERMA = 150; // mm por corte

// Sistemas y perfiles (precargados)
const SYSTEMS = {
  "Ventana Corrediza Europea": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 2 },
    "MTG2176": { altos: 2, anchos: 0 }
  },
  "Ventana Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 }
  }
};

/* ------------ Estado UI ------------ */
let rows = []; // filas: {alto, ancho, qty}
let ultimoResultado = null;
let sistemaName = Object.keys(SYSTEMS)[0];

/* ------------ LOGIN ------------ */
function doLogin(){
  const v = document.getElementById('password').value;
  if(v === PASSWORD){
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
  } else {
    alert('Contrase√±a incorrecta');
  }
}

/* ------------ UI init / tabla ------------ */
function initApp(){
  // cargar select sistemas
  const sel = document.getElementById('sistemaSelect');
  sel.innerHTML = '';
  Object.keys(SYSTEMS).forEach(name => {
    const o = document.createElement('option'); o.value = name; o.textContent = name; sel.appendChild(o);
  });
  sel.onchange = ()=>{ sistemaName = sel.value; clearResumen(); };
  sistemaName = sel.value;
  // add default row
  addRow();
  renderTable();
}

function addRow(){
  rows.push({ alto: '', ancho: '', qty: 1 });
  renderTable();
}

function removeRow(idx){
  rows.splice(idx,1);
  renderTable();
}

function renderTable(){
  const tbody = document.querySelector('#tablaVentanas tbody');
  tbody.innerHTML = '';
  rows.forEach((r,i) => {
    const tr = document.createElement('tr');

    const td0 = document.createElement('td'); td0.textContent = i+1;

    const td1 = document.createElement('td');
    const inAlto = document.createElement('input');
    inAlto.type='number'; inAlto.placeholder='ej. 1200'; inAlto.value = r.alto || '';
    inAlto.style.width='100%';
    inAlto.oninput = (e)=>{ rows[i].alto = (e.target.value===''? '': parseInt(e.target.value)); clearResumen(); };
    td1.appendChild(inAlto);

    const td2 = document.createElement('td');
    const inAncho = document.createElement('input');
    inAncho.type='number'; inAncho.placeholder='ej. 800'; inAncho.value = r.ancho || '';
    inAncho.style.width='100%';
    inAncho.oninput = (e)=>{ rows[i].ancho = (e.target.value===''? '': parseInt(e.target.value)); clearResumen(); };
    td2.appendChild(inAncho);

    const td3 = document.createElement('td');
    const inQty = document.createElement('input');
    inQty.type='number'; inQty.min=1; inQty.value = r.qty || 1;
    inQty.oninput = (e)=>{ rows[i].qty = Math.max(1, parseInt(e.target.value)||1); clearResumen(); };
    inQty.style.width='100%';
    td3.appendChild(inQty);

    const td4 = document.createElement('td');
    const btnDel = document.createElement('button'); btnDel.textContent='Eliminar'; btnDel.className='inlinebtn';
    btnDel.onclick = ()=>{ if(confirm('Eliminar esta fila?')) removeRow(i); };
    td4.appendChild(btnDel);

    tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
    tbody.appendChild(tr);
  });
}

/* ------------ Clear / Reset ------------ */
function clearResumen(){ document.getElementById('resumenBox').innerHTML = ''; ultimoResultado = null; }
function clearAll(){
  if(!confirm('Borrar todas las filas y el resumen?')) return;
  rows = [];
  addRow();
  renderTable();
  clearResumen();
  document.getElementById('largoTira').value = 6000;
}

/* ------------ Packing heur√≠stico mejorado (FFD + best-fit attempt) ------------ */
/*
 Strategy:
 1) For each profile: generate list of pieces (value = length in mm).
 2) Expand pieces according to qty (from rows).
 3) Sort pieces descending (largest first).
 4) First-Fit Decreasing: for each piece, try to place in the first bin (tira) where it fits (considering piece + MERMA).
 5) After initial packing, try a re-packing pass: try to move pieces between bins to reduce number of bins
    ‚Äî attempt to merge small pieces from bins with large leftover into bins with slightly larger remaining space.
 This is a heuristic: fast and often significantly better than naive greedy.
*/

function packPieces(pieces, largoDisponible){
  // pieces: array of numbers (lengths)
  // returns array of tiras: {cortes: [...], sobrante: N}

  // defensive
  if(!Array.isArray(pieces)) pieces = [];

  // sort desc
  let arr = pieces.slice().filter(x=>Number(x)>0).map(x=>Number(x));
  arr.sort((a,b)=>b-a);

  let bins = []; // each bin: {remain, cortes: []}

  // First-Fit Decreasing
  arr.forEach(p => {
    const ocupa = p + MERMA;
    // find first bin where it fits
    let placed = false;
    for(let b of bins){
      if(ocupa <= b.remain){
        b.cortes.push(p);
        b.remain -= ocupa;
        placed = true;
        break;
      }
    }
    if(!placed){
      // create new bin
      let rem = largoDisponible - ocupa;
      if(rem < 0) rem = 0; // piece larger than available -> still create bin with 0 remain (should be noticed)
      bins.push({ cortes: [p], remain: rem });
    }
  });

  // Attempt to improve: try to move largest remaining pieces into other bins' short holes
  // Simple local optimization: for each bin with small remain, try to move a piece from other bins that fits better
  let improved = true;
  let iterations = 0;
  while(improved && iterations < 5){
    improved = false;
    iterations++;
    // sort bins by remain ascending to try fill the smallest holes first
    bins.sort((a,b)=>a.remain - b.remain);
    for(let i=0;i<bins.length;i++){
      let target = bins[i];
      if(target.remain <= 0) continue;
      // try find from other bins a piece that fits target.remain (considering MERMA)
      let best = { fromIdx:-1, piece:-1, wasteAfter: Infinity };
      for(let j=0;j<bins.length;j++){
        if(j===i) continue;
        for(let k=0;k<bins[j].cortes.length;k++){
          let piece = bins[j].cortes[k];
          let occupies = piece + MERMA;
          if(occupies <= target.remain){
            // evaluate resulting waste if moved
            let newWaste = bins[j].remain + occupies - target.remain; // approximate
            if(newWaste < best.wasteAfter){
              best = { fromIdx:j, piece:piece, piecePos:k, wasteAfter:newWaste };
            }
          }
        }
      }
      if(best.fromIdx !== -1){
        // move piece
        bins[best.fromIdx].cortes.splice(best.piecePos,1);
        bins[best.fromIdx].remain += best.piece + MERMA;
        target.cortes.push(best.piece);
        target.remain -= best.piece + MERMA;
        // remove empty bins if any
        for(let bIx = bins.length-1; bIx>=0; bIx--){
          if(bins[bIx].cortes.length === 0){
            bins.splice(bIx,1);
          }
        }
        improved = true;
        break; // restart loop
      }
    }
  }

  // Build final structure
  const result = bins.map(b=>({ cortes: b.cortes.slice(), sobrante: b.remain }));
  return result;
}

/* ------------ Main calculate function (build pieces per profile from rows) ------------ */
function calcular(){
  clearResumen();

  // validate rows and largo
  const largoDisponible = Number(document.getElementById('largoTira').value);
  if(!largoDisponible || largoDisponible <= 0){ alert('Especifica un largo de tira v√°lido'); return; }

  // build pieces for each profile
  const perfilesDef = SYSTEMS[sistemaName];
  // initialize arrays
  let piezasPorPerfil = {};
  Object.keys(perfilesDef).forEach(code => piezasPorPerfil[code] = []);

  // iterate rows (windows)
  rows.forEach((r)=>{
    if(!r || !r.alto || !r.ancho || !r.qty || r.qty <= 0) return;
    const qty = Math.max(1, Number(r.qty));
    Object.entries(perfilesDef).forEach(([code, def])=>{
      for(let q=0;q<qty;q++){
        if(def.altos) for(let a=0;a<def.altos;a++) piezasPorPerfil[code].push(Number(r.alto));
        if(def.anchos) for(let b=0;b<def.anchos;b++) piezasPorPerfil[code].push(Number(r.ancho));
      }
    });
  });

  // pack per profile
  const tirasPorPerfil = {};
  const resumen = {};
  Object.entries(piezasPorPerfil).forEach(([code, piezas])=>{
    // quick filter
    const validPieces = piezas.filter(x=>Number(x)>0);
    if(validPieces.length === 0){
      tirasPorPerfil[code] = [];
      resumen[code] = 0;
      return;
    }
    // pack using heuristic
    const tiras = packPieces(validPieces, largoDisponible);
    // convert negative sobrante to 0 (safety)
    tiras.forEach(t=>{ if(t.sobrante < 0) t.sobrante = 0; });
    tirasPorPerfil[code] = tiras;
    resumen[code] = tiras.length;
  });

  // store last result for export
  ultimoResultado = {
    sistemaName,
    largoDisponible,
    filas: JSON.parse(JSON.stringify(rows)),
    resumen,
    tirasPorPerfil
  };

  // show only summary per requirement
  mostrarResumenEnPantalla(resumen);
}

/* ------------ Mostrar resumen en pantalla (solo totales por perfil) ------------ */
function mostrarResumenEnPantalla(resumen){
  // only totals per profile
  let html = `<h2>üî¢ Resumen global (solo totales)</h2>`;
  html += `<div class="small">Sistema: <b>${sistemaName}</b> ‚Äî Largo tira: <b>${document.getElementById('largoTira').value} mm</b></div>`;
  html += '<div style="margin-top:10px"><ul>';
  Object.entries(resumen).forEach(([code, n])=>{
    html += `<li><b>Total tiras ${code} = ${n}</b></li>`;
  });
  html += '</ul></div>';
  document.getElementById('resumenBox').innerHTML = html;
}

/* ------------ Exportar PDF (listado de ventanas, resumen por perfil, diagramas gr√°ficos) ------------ */
function exportPdfAll(){
  if(!ultimoResultado){
    // auto calcular si no hay resultado
    calcular();
    if(!ultimoResultado) return;
  }
  const data = ultimoResultado;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 36;
  let y = margin;

  // Header
  doc.setFontSize(16); doc.text('Optimizaci√≥n de Cortes - Resumen del Proyecto', pageW/2, y, {align:'center'}); y += 18;
  doc.setFontSize(10); doc.text(`Sistema: ${data.sistemaName}`, margin, y); doc.text(`Largo tira: ${data.largoDisponible} mm`, margin+220, y); y += 12;
  doc.text(`Fecha: ${new Date().toLocaleString()}`, margin, y); y += 16;

  // Ventanas ingresadas
  doc.setFontSize(12); doc.text('Ventanas ingresadas:', margin, y); y += 12;
  doc.setFontSize(10);
  // table header
  doc.text('N', margin, y); doc.text('Alto (mm)', margin+40, y); doc.text('Ancho (mm)', margin+140, y); doc.text('Cantidad', margin+260, y);
  y += 10;
  (data.filas || []).forEach((f,i)=>{
    if(y > pageH - 100){ doc.addPage(); y = margin; }
    doc.text(String(i+1), margin, y); doc.text(String(f.alto || '-'), margin+40, y);
    doc.text(String(f.ancho || '-'), margin+140, y); doc.text(String(f.qty || '-'), margin+260, y);
    y += 10;
  });
  y += 10;

  // Resumen global por perfil
  doc.setFontSize(12); doc.text('üî¢ Resumen global (tiras por perfil):', margin, y); y += 12;
  doc.setFontSize(10);
  const perfiles = Object.keys(data.resumen);
  perfiles.forEach(code=>{
    if(y > pageH - 100){ doc.addPage(); y = margin; }
    doc.text(`${code} = ${data.resumen[code]} tiras`, margin, y);
    y += 10;
  });
  y += 12;

  // Diagramas por perfil
  doc.setFontSize(12); doc.text('üìê Diagramas de cortes por perfil', margin, y); y += 14;

  // Prepare diagram scaling
  const usableW = pageW - margin*2;
  // leave legend column width
  const leftLabel = margin;
  const barMaxWidth = Math.min(usableW - 80, 460); // cap width to keep readability
  const barHeight = 14;
  const gap = 16;

  for(const code of perfiles){
    if(y > pageH - 120){ doc.addPage(); y = margin; }
    doc.setFontSize(11); doc.text(`${code} ‚Äî Tiras: ${data.resumen[code]}`, leftLabel, y); y += 10;
    const tiras = data.tirasPorPerfil[code] || [];
    if(tiras.length === 0){
      doc.setFontSize(10); doc.text('No hay piezas para este perfil.', leftLabel+8, y); y += 14; continue;
    }
    const scale = barMaxWidth / data.largoDisponible;

    // draw each tira
    for(let ti=0; ti<tiras.length; ti++){
      if(y > pageH - 100){ doc.addPage(); y = margin; }
      const tira = tiras[ti];
      let x = leftLabel + 60;
      const baseY = y;
      // outline bar background
      doc.setDrawColor(200);
      doc.rect(x, baseY, barMaxWidth, barHeight);
      // draw cuts
      for(const corte of tira.cortes){
        const occupies = (corte + MERMA) * scale;
        // fill block
        doc.setFillColor(100,150,255);
        doc.rect(x, baseY, occupies, barHeight, 'F');
        // text (centered)
        doc.setFontSize(8);
        doc.setTextColor(255,255,255);
        if(occupies > 30){
          doc.text(`${corte} mm`, x + occupies/2, baseY + barHeight/2 + 3, {align:'center'});
        } else {
          // small block -> put text below
          doc.setTextColor(40,40,40);
          doc.text(`${corte} mm`, x + occupies/2, baseY + barHeight + 10, {align:'center'});
        }
        x += occupies;
      }
      // sobrante
      if(tira.sobrante > 0){
        const sobraW = tira.sobrante * scale;
        doc.setFillColor(220,220,220);
        doc.rect(x, baseY, sobraW, barHeight, 'F');
        doc.setFontSize(8);
        doc.setTextColor(40,40,40);
        doc.text(`Sobrante ${tira.sobrante} mm`, x + sobraW/2, baseY + barHeight/2 + 3, {align:'center'});
      }
      // label left
      doc.setFontSize(9); doc.setTextColor(0,0,0);
      doc.text(`Tira ${ti+1}`, leftLabel, baseY + barHeight/2 + 3);
      y += gap;
    }
    y += 8;
  }

  // finalize
  doc.save('reporte_optimizacion_cortes.pdf');
}

/* ------------ End ------------ */

// initialize app on page load if password is empty? no, wait for login
</script>
</body>
</html>

