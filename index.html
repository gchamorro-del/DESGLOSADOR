<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Optimizador TÃ©cnico de Cortes â€” Completo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{
    --bg:#111317; --panel:#1b1f23; --text:#e6eef6; --muted:#98a2b3;
    --accent:#2ec4b6; --danger:#ef4444; --border:#2a2f33;
  }
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;
       background:linear-gradient(180deg,#0b0d0f,#0f1315);color:var(--text)}
  header{background:#071017;padding:14px 20px;display:flex;justify-content:space-between;
         align-items:center;border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:18px;color:var(--accent)}
  .wrap{max-width:1200px;margin:18px auto;padding:12px}
  .panel{background:linear-gradient(180deg,#0f1720,#0b1013);
         border-radius:10px;padding:14px;border:1px solid var(--border)}
  label{color:var(--muted);font-size:13px}
  input, select, button{font-size:14px}
  input[type="text"], input[type="number"], select{
    width:100%;padding:8px;border-radius:6px;
    border:1px solid #22303a;background:#071018;color:var(--text)
  }
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border:1px solid var(--border);
        font-size:13px;color:var(--text);text-align:center}
  th{background:#071820;color:var(--muted)}
  .row{display:flex;gap:10px}
  .col{flex:1}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#041018;padding:8px 12px;border-radius:6px;
       border:none;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid #2a3338;color:var(--text)}
  .btn.danger{background:var(--danger);color:#fff}
  #summary{margin-top:12px;padding:10px;border-radius:8px;
           border:1px solid var(--border);background:#071319;color:var(--text)}
  .muted{color:var(--muted);font-size:13px}
  .login-box{max-width:520px;margin:80px auto;padding:18px;border-radius:10px;
             background:linear-gradient(180deg,#071014,#081218);border:1px solid var(--border)}
  .center{text-align:center}
  .small{font-size:12px;color:var(--muted)}
  @media(max-width:860px){ .row{flex-direction:column} .col{width:100%} }
</style>
</head>
<body>
<header>
  <h1>ðŸ”© Optimizador TÃ©cnico de Cortes â€” VersiÃ³n Final</h1>
  <div id="hdrUser" class="small">Offline â€¢ Tema tÃ©cnico</div>
</header>

<div class="wrap">
  <!-- LOGIN -->
  <div id="loginSection" class="login-box panel">
    <h2 style="color:var(--text);margin:0 0 8px 0">Acceso</h2>
    <div class="row" style="gap:8px">
      <div class="col">
        <label>Usuario (nombre):</label>
        <input id="loginUser" type="text" placeholder="Ej. Gustavo Chamorro">
      </div>
      <div style="width:180px">
        <label>ContraseÃ±a:</label>
        <input id="loginPass" type="password" placeholder="ContraseÃ±a">
      </div>
    </div>
    <div style="margin-top:12px" class="actions">
      <button class="btn" onclick="doLogin()">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">
      ContraseÃ±a fija por defecto: <b>1234</b>
    </p>
  </div>

  <!-- APP -->
  <div id="appSection" style="display:none">
    <div class="panel">
      <div class="row" style="align-items:center;gap:12px">
        <div class="col">
          <label>Proyecto / Cliente</label>
          <input id="projectName" type="text" placeholder="Ej. Proyecto Alfa - Edificio A">
        </div>
        <div style="width:220px">
          <label>Largo disponible de tira (mm)</label>
          <input id="globalLargo" type="number" value="6000" min="1000">
        </div>
        <div style="width:220px">
          <label>&nbsp;</label>
          <div class="actions">
            <button class="btn" onclick="addRow()">âž• Agregar ventana</button>
            <button class="btn ghost" onclick="calcular()">ðŸ§® Calcular resumen</button>
            <button class="btn" onclick="exportPdf()">ðŸ“„ Exportar PDF</button>
            <button class="btn danger" onclick="borrarTodo()">ðŸ—‘ Borrar todo</button>
          </div>
        </div>
      </div>

      <h3 style="margin-top:14px;color:var(--accent)">Ventanas (ingreso manual)</h3>

      <table id="tableWindows">
        <thead>
          <tr>
            <th>ID Ventana</th>
            <th>Ancho (mm)</th>
            <th>Alto (mm)</th>
            <th>Cantidad</th>
            <th>Sistema</th>
            <th>Largo Tira (mm)</th>
            <th>Eliminar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="summary" class="muted center">
        Presiona "Calcular resumen" para ver totales por perfil.
      </div>
    </div>
  </div>
</div>

<script>
const PASSWORD = "1234";
const MERMA = 50;
let currentUser = null;
let lastResults = null;

const SYSTEMS = {
  "Corrediza Europea 3 Hojas": {
    "MTG1399": { altos: 2, anchos: 2 },
    "MTG2177": { altos: 4, anchos: 4, dividirAncho: true },
    "MTG2176": { altos: 4, anchos: 0 },
    "F04": { tipo: "herraje", calcularSegun: { "MTG2177": 2, "MTG2176": 1 } },
    "EUAA05L": { cantidad: 20, tipo: "herraje" },
    "EUAP01": { cantidad: 1.5, tipo: "herraje" },
    "EUCH01": { cantidad: 2, tipo: "herraje" },
    "EUCH02": { cantidad: 2, tipo: "herraje" },
  },
  "Fija": {
    "MTG2180": { altos: 2, anchos: 2 },
    "MTG2184": { altos: 2, anchos: 2 },
    "EUAA01": { cantidad: 4, tipo: "herraje" },
  },
  "Batiente": {},
  "ProyecciÃ³n": {},
  "Otro": {}
};

function doLogin(){
  const u=document.getElementById('loginUser').value.trim();
  const p=document.getElementById('loginPass').value;
  if(!u||!p){alert('Ingrese usuario y contraseÃ±a');return;}
  if(p!==PASSWORD){alert('ContraseÃ±a incorrecta');document.getElementById('loginPass').value='';return;}
  currentUser=u;
  document.getElementById('hdrUser').innerText=`Usuario: ${u}`;
  document.getElementById('loginSection').style.display='none';
  document.getElementById('appSection').style.display='block';
  addRow();
}

function addRow(){
  const tbody=document.querySelector('#tableWindows tbody');
  const tr=document.createElement('tr');
  const defaultLargo=parseInt(document.getElementById('globalLargo').value)||6000;
  tr.innerHTML=`
    <td><input type="text" placeholder="V1"></td>
    <td><input type="number" placeholder="1000"></td>
    <td><input type="number" placeholder="1500"></td>
    <td><input type="number" value="1" min="1"></td>
    <td><select>${Object.keys(SYSTEMS).map(s=>`<option value="${s}">${s}</option>`).join('')}</select></td>
    <td><input type="number" value="${defaultLargo}" min="1000"></td>
    <td><button class="btn ghost" onclick="this.closest('tr').remove()">X</button></td>`;
  tbody.appendChild(tr);
}

/* ---------------- SOLVER OPTIMIZADO ---------------- */
function optimizarCortesExacto(cortes, largoTira, merma = MERMA) {
  if (!cortes || cortes.length === 0) return [];
  const piezas = cortes.map(c => c + merma).sort((a,b)=>b-a);
  const tiras = [];
  piezas.forEach(pieza => {
    let mejorTira=null;
    let menorEspacio=Infinity;
    for (const tira of tiras) {
      if (tira.sobrante >= pieza && tira.sobrante - pieza < menorEspacio) {
        mejorTira=tira; menorEspacio=tira.sobrante - pieza;
      }
    }
    if (mejorTira) {
      mejorTira.cortes.push(pieza - merma);
      mejorTira.sobrante -= pieza;
    } else {
      tiras.push({ cortes:[pieza - merma], largo:largoTira, sobrante:largoTira - pieza });
    }
  });
  tiras.forEach(t => t.cortes.sort((a,b)=>b-a));
  return tiras;
}

/* ---------------- CALCULAR ---------------- */
function calcular(){
  const rows=[...document.querySelectorAll('#tableWindows tbody tr')];
  if(!rows.length){alert("Agrega al menos una ventana.");return;}
  const resumen={};
  for(const tr of rows){
    const id=tr.children[0].querySelector('input').value||'SIN_ID';
    const ancho=parseFloat(tr.children[1].querySelector('input').value);
    const alto=parseFloat(tr.children[2].querySelector('input').value);
    const cant=parseInt(tr.children[3].querySelector('input').value)||1;
    const sistema=tr.children[4].querySelector('select').value;
    const largo=parseInt(tr.children[5].querySelector('input').value)||6000;
    if(isNaN(ancho)||isNaN(alto)) continue;

    const sys=SYSTEMS[sistema];
    for(const [perfil,conf] of Object.entries(sys)){
      if(conf.tipo==="herraje"){
        resumen[perfil]=(resumen[perfil]||0)+(conf.cantidad||0)*cant;
        continue;
      }
      const cortes=[];
      if(conf.anchos>0){ for(let i=0;i<conf.anchos;i++) cortes.push(conf.dividirAncho?ancho/2:ancho); }
      if(conf.altos>0){ for(let i=0;i<conf.altos;i++) cortes.push(alto); }
      const totales=[];
      for(let i=0;i<cant;i++) totales.push(...cortes);
      if(!resumen[perfil]) resumen[perfil]=[];
      resumen[perfil].push(...totales);
    }
  }

  let html="";
  for(const [perfil,cortes] of Object.entries(resumen)){
    if(typeof cortes==="number"){
      html+=`<p><b>${perfil}</b>: ${cortes.toFixed(2)} unidades (herrajes)</p>`;
      continue;
    }
    const largoBase=parseInt(document.getElementById('globalLargo').value)||6000;
    const resultado=optimizarCortesExacto(cortes,largoBase);
    const usado=resultado.reduce((a,b)=>a+b.cortes.reduce((x,y)=>x+y,0),0);
    const total=resultado.length*largoBase;
    const mermaTotal=total-usado;
    html+=`<div><b>${perfil}</b>: ${resultado.length} tiras â€” Merma total ${mermaTotal.toFixed(1)} mm</div>`;
  }
  document.getElementById('summary').innerHTML=html||"Sin resultados.";
}

/* ---------------- EXPORTAR PDF ---------------- */
function exportPdf(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  const title=document.getElementById('projectName').value||"Proyecto sin nombre";
  doc.text(`Resumen de cortes â€” ${title}`,10,10);
  doc.text(`Usuario: ${currentUser||"N/A"}`,10,18);
  doc.text("Fecha: "+new Date().toLocaleString(),10,26);
  const contenido=document.getElementById('summary').innerText||"Sin resultados";
  const split=doc.splitTextToSize(contenido,180);
  doc.text(split,10,40);
  doc.save(`${title.replace(/\s+/g,'_')}_resumen.pdf`);
}

/* ---------------- BORRAR TODO ---------------- */
function borrarTodo(){
  if(!confirm("Â¿Seguro que deseas borrar todos los datos?")) return;
  document.querySelector('#tableWindows tbody').innerHTML="";
  document.getElementById('summary').innerHTML='Presiona "Calcular resumen" para ver totales por perfil.';
  addRow();
}
</script>
</body>
</html>
